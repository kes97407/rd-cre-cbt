<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>CRE Practice CBT</title>

<style>
  body {
    font-family: Arial, system-ui, sans-serif;
    margin: 0;
    padding: 0;
    background:#f2f4f7;
  }

  /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
  .container {
    max-width: 1100px;
    margin: 20px auto;
    background:#fff;
    border-radius:10px;
    padding:20px 24px 40px;
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
    display:none;
  }

  h1 { margin-top:0; }

  .controls {
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    margin-bottom:16px;
    padding:12px;
    background:#f7f9fc;
    border-radius:8px;
  }

  .controls > div { min-width: 180px; }

  label {
    font-size:14px;
    font-weight:600;
    display:block;
    margin-bottom:4px;
  }

  select, input, textarea {
    width:100%;
    padding:6px 8px;
    font-size:14px;
    box-sizing:border-box;
  }

  button {
    padding:8px 14px;
    font-size:14px;
    cursor:pointer;
    border-radius:6px;
    border:1px solid #1f6feb;
    background:#1f6feb;
    color:#fff;
  }

  button.secondary {
    background:#fff;
    color:#1f2933;
    border-color:#cbd2e1;
  }

  button.danger {
    background:#e11d48;
    border-color:#e11d48;
    color:#fff;
  }

  #timer { font-size:18px; font-weight:bold; color:#e11d48; }
  #modeDesc { font-size:13px; color:#4b5563; margin-top:4px; }

  /* ë¬¸ì œ ì˜ì—­ */
  .question-block {
    margin-bottom:20px;
    padding-bottom:12px;
    border-bottom:1px solid #e5e7eb;
  }

  /* 2ë‹¨ ë³´ê¸° */
  .question-block.dual { display:flex; gap:16px; }
  .q-left, .q-right { width:50%; box-sizing:border-box; }
  .q-right {
    border-left:1px solid #e5e7eb;
    padding-left:14px;
    font-size:13px;
  }

  @media (max-width: 900px){
    .question-block.dual{ flex-direction:column; }
    .q-left,.q-right{ width:100%; }
    .q-right{
      border-left:none;
      border-top:1px solid #e5e7eb;
      padding-left:0;
      padding-top:8px;
    }
  }

  #resultBox {
    margin-top:24px;
    padding:16px;
    border-radius:8px;
    background:#ecfeff;
    border:1px solid #7dd3fc;
  }

  /* ì˜¤ë‹µ/ì ìˆ˜ íŒ¨ë„ */
  .panel-row {
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    margin-top:20px;
  }
  .panel {
    flex:1;
    min-width:260px;
    background:#f9fafb;
    border-radius:8px;
    padding:10px 12px;
    border:1px solid #e5e7eb;
    max-height:300px;
    overflow:auto;
  }

  /* ë¹„ë°€ë²ˆí˜¸ ê²Œì´íŠ¸ */
  #gateOverlay {
    position:fixed;
    inset:0;
    background:rgba(15,23,42,0.9);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:9999;
  }
  #gateBox {
    background:#f9fafb;
    border-radius:12px;
    padding:24px 26px;
    width:320px;
    box-shadow:0 10px 30px rgba(0,0,0,0.4);
  }
  #gateMessage { font-size:12px; color:#dc2626; height:16px; margin-top:6px; }
</style>
</head>
<body>

<!-- ğŸ” ë¹„ë°€ë²ˆí˜¸ ê²Œì´íŠ¸ -->
<div id="gateOverlay">
  <div id="gateBox">
    <h2>CRE ì—°ìŠµ ì‚¬ì´íŠ¸</h2>
    <p style="font-size:13px;color:#4b5563;">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
    <input type="password" id="gatePassword" placeholder="ë¹„ë°€ë²ˆí˜¸" />
    <div id="gateMessage"></div>
    <button id="gateBtn">ì…ì¥</button>
  </div>
</div>

<!-- ğŸ§± ë©”ì¸ CBT ì»¨í…Œì´ë„ˆ -->
<div class="container" id="appContainer">
  <h1>CRE Practice CBT</h1>
  <p style="font-size:13px;color:#4b5563;">
    ê¸°ê¸° ê°„ ë™ê¸°í™”ê°€ ê°€ëŠ¥í•œ CBT ì‹œìŠ¤í…œì…ë‹ˆë‹¤.
  </p>

  <!-- ğŸ”§ ìƒë‹¨ ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
  <div class="controls">
    <div>
      <label>ì±•í„°</label>
      <select id="chapterSelect"></select>
    </div>

    <div>
      <label>ë¬¸ì œ íƒ€ì…</label>
      <select id="typeSelect">
        <option value="all">ì „ì²´</option>
        <option value="A">A</option>
        <option value="C">C</option>
      </select>
    </div>

    <div>
      <label>ì¶œì œ ëª¨ë“œ</label>
      <select id="modeSelect">
        <option value="normal">ì¼ë°˜ëª¨ë“œ</option>
        <option value="wrong">ì˜¤ë‹µëª¨ë“œ</option>
        <option value="weak">ì•½ì ëª¨ë“œ</option>
      </select>
      <div id="modeDesc"></div>
    </div>

    <div>
      <label>ë¬¸í•­ ìˆ˜</label>
      <input type="number" id="countInput" value="20" min="1" />
    </div>

    <div>
      <label>íƒ€ì´ë¨¸ (ë¶„)</label>
      <input type="number" id="timerInput" value="0" min="0" />
    </div>

    <div>
      <label>&nbsp;</label>
      <button id="startBtn">ì‹œì‘</button>
    </div>

    <div>
      <label>&nbsp;</label>
      <button id="resetBtn" disabled>ì´ˆê¸°í™”</button>
    </div>

    <div>
      <label>&nbsp;</label>
      <button id="submitBtn" disabled>ì œì¶œ</button>
    </div>

    <div>
      <label>2ë‹¨ ë³´ê¸°</label>
      <input type="checkbox" id="dualViewToggle" />
    </div>

    <div style="flex:1;">
      <label>íƒ€ì´ë¨¸ ìƒíƒœ</label>
      <div id="timer">Timer: OFF</div>
    </div>
  </div>

  <!-- ğŸ“ ë¬¸ì œ ì¶œë ¥ -->
  <div id="quizBox"></div>

  <!-- ğŸ§¾ ê²°ê³¼ -->
  <div id="resultBox"></div>

  <!-- ğŸ“š ì˜¤ë‹µë…¸íŠ¸ + ì ìˆ˜ íŒ¨ë„ -->
  <div class="panel-row">
    <div class="panel">
      <h3>ì˜¤ë‹µ ë…¸íŠ¸</h3>
      <div id="wrongNotesBox"></div>
      <button class="danger" id="clearWrongBtn">ì˜¤ë‹µ ì‚­ì œ</button>
    </div>

    <div class="panel">
      <h3>ì ìˆ˜ ê¸°ë¡</h3>
      <div id="scoreHistoryBox"></div>
      <button class="danger" id="clearScoreBtn">ê¸°ë¡ ì‚­ì œ</button>
    </div>
  </div>

  <!-- â• ì‚¬ìš©ì ë¬¸ì œ ì¶”ê°€ -->
  <h3 style="margin-top:30px;">ì‚¬ìš©ì ë¬¸ì œ ì¶”ê°€</h3>
  <form id="addQuestionForm">
    <div class="controls">
      <div><label>ID</label><input id="addId" /></div>
      <div><label>ì±•í„°</label><select id="addChapter"></select></div>
      <div><label>íƒ€ì…</label>
        <select id="addType">
          <option value="A">A</option>
          <option value="C">C</option>
        </select>
      </div>
      <div><label>ì •ë‹µ (0~3)</label><input id="addAnswer" type="number" min="0" max="3" /></div>
    </div>

    <label>ë¬¸ì œ</label>
    <textarea id="addText"></textarea>

    <label>ë³´ê¸° A</label><input id="addOpA" />
    <label>ë³´ê¸° B</label><input id="addOpB" />
    <label>ë³´ê¸° C</label><input id="addOpC" />
    <label>ë³´ê¸° D</label><input id="addOpD" />

    <label>í•´ì„¤</label>
    <textarea id="addExplanation"></textarea>

    <button style="margin-top:12px;">ë¬¸ì œ ì¶”ê°€</button>
  </form>

  <!-- ğŸ“¤ JSON ì—…ë¡œë“œ -->
  <h3 style="margin-top:30px;">ë¬¸ì œ JSON ì—…ë¡œë“œ</h3>
  <input type="file" id="uploadFileInput" />
  <button id="uploadFileBtn">ì—…ë¡œë“œ</button>

  <!-- ì‚¬ìš©ì ë¬¸ì œ ê´€ë¦¬ -->
  <div style="margin-top:20px;">
    <button class="danger" id="clearCustomBtn">ì‚¬ìš©ì ë¬¸ì œ ì „ì²´ ì‚­ì œ</button>
    <button class="secondary" id="exportCustomBtn">ì‚¬ìš©ì ë¬¸ì œ ë‚´ë³´ë‚´ê¸°</button>
  </div>

</div> <!-- appContainer ë -->

<!-- â–¼â–¼â–¼ PART 2 ì‹œì‘ â–¼â–¼â–¼ -->
<script>
/*******************************************************
 * 0. ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
 *******************************************************/
const APP_PASSWORD = "cre2025";

/*******************************************************
 * 1. Firebase ì„¤ì • (ë„¤ í”„ë¡œì íŠ¸ ê°’)
 *******************************************************/
const firebaseConfig = {
  apiKey: "AIzaSyBYrsPIpbP7wBMJk8QrU9vUtF0JDhfn2C4",
  authDomain: "rd-cre-cbt-sync.firebaseapp.com",
  projectId: "rd-cre-cbt-sync",
  storageBucket: "rd-cre-cbt-sync.firebasestorage.app",
  messagingSenderId: "1085101263930",
  appId: "1:1085101263930:web:06d1339169b431b63e3903"
};
</script>

<!-- Firebase SDK (v8) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
/*******************************************************
 * 2. Firebase ì´ˆê¸°í™”
 *******************************************************/
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/*******************************************************
 * 3. ë¸Œë¼ìš°ì € Device ID (ë¡œê·¸ì¸ ì—†ì´ ê¸°ê¸° ê°„ ë™ê¸°í™”)
 *******************************************************/
let deviceId = localStorage.getItem("creDeviceId");
if (!deviceId) {
  deviceId = "dev-" + Math.random().toString(36).substring(2) + Date.now();
  localStorage.setItem("creDeviceId", deviceId);
}

function userPath() {
  return `users/${deviceId}`;
}

/*******************************************************
 * 4. Firestore â†’ LocalStorage ë™ê¸°í™”
 *******************************************************/
async function syncFromCloud() {
  try {
    // WRONG NOTES
    const wn = [];
    const wSnap = await db.collection(`${userPath()}/wrongNotes`).get();
    wSnap.forEach(doc => wn.push(doc.data()));
    localStorage.setItem("creWrongNotes", JSON.stringify(wn));

    // SCORE HISTORY
    const sc = [];
    const sSnap = await db.collection(`${userPath()}/scores`).get();
    sSnap.forEach(doc => sc.push(doc.data()));
    localStorage.setItem("creScoreHistory", JSON.stringify(sc));

    console.log("â˜ í´ë¼ìš°ë“œ â†’ ë¡œì»¬ ë™ê¸°í™” ì™„ë£Œ");
  } catch (e) {
    console.error("ë™ê¸°í™” ì˜¤ë¥˜:", e);
  }
}

/*******************************************************
 * 5. LocalStorage â†’ Firestore ì—…ë¡œë“œ
 *******************************************************/
async function syncToCloud() {
  try {
    // WRONG NOTES
    const wrongArr = JSON.parse(localStorage.getItem("creWrongNotes") || "[]");
    for (const w of wrongArr) {
      await db.collection(`${userPath()}/wrongNotes`).doc(w.id).set(w);
    }

    // SCORES
    const scoreArr = JSON.parse(localStorage.getItem("creScoreHistory") || "[]");
    for (const h of scoreArr) {
      const key = h.date.replace(/[\s:]/g, "_");
      await db.collection(`${userPath()}/scores`).doc(key).set(h);
    }

    console.log("ğŸ’¾ ë¡œì»¬ â†’ í´ë¼ìš°ë“œ ì—…ë¡œë“œ ì™„ë£Œ");
  } catch (e) {
    console.error("ì—…ë¡œë“œ ì‹¤íŒ¨:", e);
  }
}

/*******************************************************
 * 6. ë¹„ë°€ë²ˆí˜¸ ê²Œì´íŠ¸
 *******************************************************/
function setupGate() {
  const overlay = document.getElementById("gateOverlay");
  const app = document.getElementById("appContainer");
  const input = document.getElementById("gatePassword");
  const btn = document.getElementById("gateBtn");
  const msg = document.getElementById("gateMessage");

  function enterGate() {
    if (input.value === APP_PASSWORD) {
      overlay.style.display = "none";
      app.style.display = "block";

      syncFromCloud().then(() => {
        renderWrongNotes();
        renderScoreHistory();
        refreshChapterDropdown();
      });

    } else {
      msg.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
    }
  }

  btn.addEventListener("click", enterGate);

  input.addEventListener("keydown", e => {
    if (e.key === "Enter") enterGate();
  });
}

</script>
<!-- â–²â–²â–² PART 2 ë â–²â–²â–² -->
<!-- â–¼â–¼â–¼ PART 3 ì‹œì‘ â–¼â–¼â–¼ -->
<script>
/******************************************************************
 * 7. ê¸°ë³¸ ë¬¸ì œ ë°ì´í„° (ìƒ˜í”Œ)
 *   â†’ ë„¤ê°€ JSON ì—…ë¡œë“œë¡œ ì›í•˜ëŠ” ë§Œí¼ í™•ì¥í•  ìˆ˜ ìˆìŒ
 ******************************************************************/
const BASE_QUESTIONS = [
  {
    id:"Q1",
    chapter:"Sample - Statistical Concepts",
    type:"C",
    text:"For an exponential distribution with MTBF = 800 hours, what is the reliability at 400 hours?",
    options:["0.50","0.61","0.37","0.80"],
    answer:1,
    explanation:"R(t) = exp(-t/MTBF) = exp(-0.5) = 0.606"
  },
  {
    id:"Q2",
    chapter:"Sample - Statistical Concepts",
    type:"A",
    text:"In a Weibull distribution, what does a shape parameter Î² greater than 1 indicate?",
    options:["Early failures","Wear-out failures","Constant failure rate","Random failures"],
    answer:1,
    explanation:"Î² > 1 indicates wear-out failures"
  }
];

/******************************************************************
 * 8. LocalStorage Helper
 ******************************************************************/
const loadWrongNotes = () =>
  JSON.parse(localStorage.getItem("creWrongNotes") || "[]");

const saveWrongNotes = v =>
  localStorage.setItem("creWrongNotes", JSON.stringify(v));

const loadScoreHistory = () =>
  JSON.parse(localStorage.getItem("creScoreHistory") || "[]");

const saveScoreHistory = v =>
  localStorage.setItem("creScoreHistory", JSON.stringify(v));

const loadCustomQuestions = () =>
  JSON.parse(localStorage.getItem("creCustomQuestions") || "[]");

const saveCustomQuestions = v =>
  localStorage.setItem("creCustomQuestions", JSON.stringify(v));

/******************************************************************
 * 9. ì±•í„° ë“œë¡­ë‹¤ìš´ ê°±ì‹ 
 ******************************************************************/
function refreshChapterDropdown() {
  const main = document.getElementById("chapterSelect");
  const add = document.getElementById("addChapter");

  const all = BASE_QUESTIONS.concat(loadCustomQuestions());
  const chapters = new Set(["ì „ì²´"]);
  all.forEach(q => chapters.add(q.chapter));

  let mainHtml = "";
  let addHtml = "";

  chapters.forEach(ch => {
    mainHtml += `<option value="${ch === "ì „ì²´" ? "all" : ch}">${ch}</option>`;
    if (ch !== "ì „ì²´") addHtml += `<option value="${ch}">${ch}</option>`;
  });

  main.innerHTML = mainHtml;
  add.innerHTML = addHtml;
}

/******************************************************************
 * 10. ì „ì²´ ë¬¸ì œ ì¡°íšŒ
 ******************************************************************/
const getAllQuestions = () =>
  BASE_QUESTIONS.concat(loadCustomQuestions());

/******************************************************************
 * 11. ì˜¤ë‹µ í‘œì‹œ
 ******************************************************************/
function renderWrongNotes() {
  const notes = loadWrongNotes();
  const box = document.getElementById("wrongNotesBox");

  if (!notes.length) {
    box.innerHTML = `<div style="font-size:12px;color:#888;">ì˜¤ë‹µ ì—†ìŒ</div>`;
    return;
  }

  box.innerHTML = notes
    .map(n => `
      <div class="note-item">
        <b>${n.id}</b> <span class="tag ${n.type}">${n.type}</span>
        <div>${n.text}</div>
        <div style="font-size:11px;color:#666;">
          ${n.chapter} Â· ${n.missCount}íšŒ Â· ${n.lastDate}
        </div>
      </div>
    `)
    .join("");
}

function clearWrongNotes() {
  if (!confirm("ì˜¤ë‹µë…¸íŠ¸ë¥¼ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?")) return;
  saveWrongNotes([]);
  renderWrongNotes();
  syncToCloud();
}

/******************************************************************
 * 12. ì ìˆ˜ ê¸°ë¡ UI
 ******************************************************************/
function renderScoreHistory() {
  const hist = loadScoreHistory();
  const box = document.getElementById("scoreHistoryBox");

  if (!hist.length) {
    box.innerHTML = `<div style="font-size:12px;color:#888;">ê¸°ë¡ ì—†ìŒ</div>`;
    return;
  }

  box.innerHTML = hist
    .slice()
    .reverse()
    .map(
      h => `
      <div class="score-item">
        <b>${h.date}</b> â€” ${h.correct}/${h.total} (${Math.round(
        (h.correct / h.total) * 100
      )}%)
        <div style="font-size:11px;color:#555;">
          ${h.mode} Â· ${h.durationSec}s
        </div>
      </div>
    `
    )
    .join("");
}

function clearScoreHistory() {
  if (!confirm("ì ìˆ˜ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?")) return;
  saveScoreHistory([]);
  renderScoreHistory();
  syncToCloud();
}

/******************************************************************
 * 13. íƒ€ì´ë¨¸
 ******************************************************************/
let timerId = null, timerSeconds = 0;

function stopTimer() {
  if (timerId !== null) {
    clearInterval(timerId);
    timerId = null;
  }
}

function updateTimerDisplay() {
  const el = document.getElementById("timer");
  if (timerSeconds <= 0) {
    el.textContent = "Timer: OFF";
    return;
  }
  const m = String(Math.floor(timerSeconds / 60)).padStart(2, "0");
  const s = String(timerSeconds % 60).padStart(2, "0");
  el.textContent = `ë‚¨ì€ ì‹œê°„: ${m}:${s}`;
}

function startTimer(sec) {
  stopTimer();
  timerSeconds = sec;
  updateTimerDisplay();
  if (sec <= 0) return;

  timerId = setInterval(() => {
    timerSeconds--;
    updateTimerDisplay();
    if (timerSeconds <= 0) {
      stopTimer();
      alert("ì‹œê°„ ì¢…ë£Œ! ìë™ ì œì¶œë©ë‹ˆë‹¤.");
      submitQuiz(true);
    }
  }, 1000);
}

/******************************************************************
 * 14. ì„ê¸° (Fisher-Yates)
 ******************************************************************/
const shuffleArray = arr => {
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
};

/******************************************************************
 * 15. ë²ˆì—­ ì—”ì§„ (ê¸°ìˆ  + ìì—° ë²ˆì—­)
 ******************************************************************/
function translateTechTerm(text) {
  if (!text) return "";
  let out = text;

  const dict = {
    reliability: "ì‹ ë¢°ë„",
    MTBF: "í‰ê· ê³ ì¥ê°„ê²©(MTBF)",
    MTTR: "í‰ê· ìˆ˜ë¦¬ì‹œê°„(MTTR)",
    "exponential distribution": "ì§€ìˆ˜ë¶„í¬",
    weibull: "ì™€ì´ë¸”",
    "failure rate": "ê³ ì¥ë¥ ",
    availability: "ê°€ìš©ë„",
    "preventive maintenance": "ì˜ˆë°©ì •ë¹„"
  };

  for (const [en, ko] of Object.entries(dict)) {
    const reg = new RegExp(en, "gi");
    out = out.replace(reg, `${ko} (${en})`);
  }

  return out;
}

function translateNaturalSentence(text) {
  if (!text) return "";
  let out = text;

  out = out.replace(/Which of the following/gi, "ë‹¤ìŒ ì¤‘");
  out = out.replace(/Which is NOT/gi, "ë‹¤ìŒ ì¤‘ ì˜³ì§€ ì•Šì€ ê²ƒì€");
  out = out.replace(/is/gi, "ì€(ëŠ”)");
  out = out.replace(/\?/g, "ì¸ê°€?");

  return out;
}

function buildKoreanBlock(q) {
  return `
    <div class="ko-header">Q${q._no} í•œê¸€ ë²ˆì—­</div>

    <div class="ko-label">ê¸°ìˆ  ë²ˆì—­</div>
    <div>${translateTechTerm(q.text)}</div>

    <div class="ko-label">ìì—° ë²ˆì—­</div>
    <div>${translateNaturalSentence(q.text)}</div>

    <div class="ko-label" style="margin-top:6px;">ë³´ê¸° ë²ˆì—­</div>
    ${q.options
      .map(
        (op, idx) =>
          `<div class="ko-option"><b>${String.fromCharCode(
            65 + idx
          )}.</b> ${translateTechTerm(op)}</div>`
      )
      .join("")}
  `;
}

/******************************************************************
 * 16. ë¬¸ì œ ì¶œë ¥
 ******************************************************************/
let currentQuiz = [];
let dualView = false;

function renderQuiz() {
  const box = document.getElementById("quizBox");
  box.innerHTML = "";

  currentQuiz.forEach((q, i) => {
    q._no = i + 1;

    if (!dualView) {
      // ì˜ì–´ë§Œ ë³´ê¸°
      let h = `
        <div class="question-block">
          <div class="question-title">Q${q._no}. ${q.text}</div>
          <div class="meta">${q.id} Â· ${q.chapter} Â· ${q.type}</div>
      `;
      q.options.forEach((op, j) => {
        h += `
          <div class="option">
            <label><input type="radio" name="q${i}" value="${j}">
            ${String.fromCharCode(65 + j)}. ${op}</label>
          </div>`;
      });
      h += `</div>`;
      box.innerHTML += h;

    } else {
      // 2ë‹¨ ë³´ê¸°
      let left = `
        <div class="q-left">
          <div class="question-title">Q${q._no}. ${q.text}</div>
          <div class="meta">${q.id} Â· ${q.chapter} Â· ${q.type}</div>
      `;
      q.options.forEach((op, j) => {
        left += `
          <div class="option">
            <label><input type="radio" name="q${i}" value="${j}">
            ${String.fromCharCode(65 + j)}. ${op}</label>
          </div>`;
      });
      left += `</div>`;

      const right = `<div class="q-right">${buildKoreanBlock(q)}</div>`;
      box.innerHTML += `<div class="question-block dual">${left}${right}</div>`;
    }
  });
}

/******************************************************************
 * 17. ì¶œì œ ëª¨ë“œ ì²˜ë¦¬
 ******************************************************************/
function buildQuestionPool() {
  const ch = document.getElementById("chapterSelect").value;
  const tp = document.getElementById("typeSelect").value;
  const mode = document.getElementById("modeSelect").value;

  const all = getAllQuestions();
  const notes = loadWrongNotes();

  if (mode === "normal") {
    return all.filter(
      q =>
        (ch === "all" || q.chapter === ch) &&
        (tp === "all" || q.type === tp)
    );
  }

  if (mode === "wrong") {
    const wrongIds = new Set(notes.map(n => n.id));
    return all.filter(
      q =>
        wrongIds.has(q.id) &&
        (ch === "all" || q.chapter === ch) &&
        (tp === "all" || q.type === tp)
    );
  }

  if (mode === "weak") {
    if (!notes.length) return [];

    // ê°€ì¥ ë§ì´ í‹€ë¦° ì±•í„° ì°¾ê¸°
    const count = {};
    notes.forEach(n => {
      count[n.chapter] = (count[n.chapter] || 0) + n.missCount;
    });

    let weak = null, max = -1;
    for (const c in count) {
      if (count[c] > max) {
        weak = c;
        max = count[c];
      }
    }

    return all.filter(q => q.chapter === weak);
  }

  return [];
}

/******************************************************************
 * 18. ì‹œí—˜ ì‹œì‘
 ******************************************************************/
function startQuiz() {
  const pool = buildQuestionPool();
  if (!pool.length) {
    alert("ì¶œì œ ê°€ëŠ¥í•œ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const cnt = Number(document.getElementById("countInput").value);
  const tm = Number(document.getElementById("timerInput").value);

  currentQuiz = shuffleArray(pool).slice(0, cnt || pool.length);

  renderQuiz();

  document.getElementById("resultBox").innerHTML = "";
  document.getElementById("startBtn").disabled = true;
  document.getElementById("submitBtn").disabled = false;
  document.getElementById("resetBtn").disabled = false;

  startTimer(tm > 0 ? tm * 60 : 0);
}

/******************************************************************
 * 19. ì œì¶œ + ì±„ì 
 ******************************************************************/
function submitQuiz(auto = false) {
  stopTimer();

  let correct = 0;
  const wrong = [];

  let html = "";

  currentQuiz.forEach((q, i) => {
    const sel = document.querySelector(`input[name="q${i}"]:checked`);
    const userAnswer = sel ? Number(sel.value) : null;

    const ok = userAnswer === q.answer;
    if (ok) correct++;
    else wrong.push(q);

    html += `
      <div style="margin-bottom:12px;">
        <b>Q${i + 1} (${q.id})</b><br>

        ì„ íƒ:
        ${
          userAnswer === null
            ? "ë¬´ì‘ë‹µ"
            : `${String.fromCharCode(65 + userAnswer)}. ${q.options[userAnswer]}`
        }<br>

        ì •ë‹µ:
        <span style="color:${ok ? "#16a34a" : "#dc2626"}">
          ${String.fromCharCode(65 + q.answer)}. ${q.options[q.answer]}
        </span>

        <div class="explanation">${q.explanation || ""}</div>
      </div>
    `;
  });

  const pct = Math.round((correct / currentQuiz.length) * 100);

  document.getElementById("resultBox").innerHTML =
    `<h3>ì ìˆ˜: ${correct}/${currentQuiz.length} (${pct}%)</h3>${html}`;

  document.getElementById("submitBtn").disabled = true;

  saveWrongAndSync(wrong);
  saveScoreAndSync(correct, currentQuiz.length, 0);
}

/******************************************************************
 * 20. ì˜¤ë‹µ ì €ì¥ + ë™ê¸°í™”
 ******************************************************************/
function saveWrongAndSync(wrongList) {
  if (!wrongList.length) return;

  const now = new Date().toLocaleString();
  let notes = loadWrongNotes();

  wrongList.forEach(q => {
    const exist = notes.find(n => n.id === q.id);
    if (exist) {
      exist.missCount++;
      exist.lastDate = now;
    } else {
      notes.push({
        id: q.id,
        text: q.text,
        chapter: q.chapter,
        type: q.type,
        missCount: 1,
        lastDate: now
      });
    }
  });

  saveWrongNotes(notes);
  renderWrongNotes();
  syncToCloud();
}

/******************************************************************
 * 21. ì ìˆ˜ ì €ì¥ + ë™ê¸°í™”
 ******************************************************************/
function saveScoreAndSync(correct, total, duration) {
  const hist = loadScoreHistory();

  hist.push({
    date: new Date().toLocaleString(),
    correct,
    total,
    durationSec: duration,
    mode: document.getElementById("modeDesc")?.textContent || ""
  });

  saveScoreHistory(hist);
  renderScoreHistory();
  syncToCloud();
}
</script>
<!-- â–²â–²â–² PART 3 ë â–²â–²â–² -->
<!-- â–¼â–¼â–¼ PART 4 ì‹œì‘ â–¼â–¼â–¼ -->
<script>
/******************************************************************
 * 22. ì´ˆê¸°í™” (Reset)
 ******************************************************************/
function resetQuiz() {
  stopTimer();
  currentQuiz = [];
  document.getElementById("quizBox").innerHTML = "";
  document.getElementById("resultBox").innerHTML = "";

  document.getElementById("startBtn").disabled = false;
  document.getElementById("submitBtn").disabled = true;
  document.getElementById("resetBtn").disabled = true;

  document.getElementById("modeDesc").textContent = "";
  document.getElementById("timer").textContent = "Timer: OFF";
}

/******************************************************************
 * 23. ì‚¬ìš©ì ë¬¸ì œ ì¶”ê°€
 ******************************************************************/
function setupAddQuestionForm() {
  const form = document.getElementById("addQuestionForm");

  form.addEventListener("submit", e => {
    e.preventDefault();

    const custom = loadCustomQuestions();

    const q = {
      id: document.getElementById("addId").value.trim(),
      chapter: document.getElementById("addChapter").value,
      type: document.getElementById("addType").value,
      text: document.getElementById("addText").value.trim(),
      options: [
        document.getElementById("addOpA").value.trim(),
        document.getElementById("addOpB").value.trim(),
        document.getElementById("addOpC").value.trim(),
        document.getElementById("addOpD").value.trim()
      ],
      answer: Number(document.getElementById("addAnswer").value),
      explanation: document.getElementById("addExplanation").value.trim()
    };

    custom.push(q);
    saveCustomQuestions(custom);
    refreshChapterDropdown();

    alert(`ë¬¸ì œ ì¶”ê°€ ì™„ë£Œ: ${q.id}`);
    form.reset();
  });
}

/******************************************************************
 * 24. JSON íŒŒì¼ ì—…ë¡œë“œ
 ******************************************************************/
function setupUploadQuestions() {
  const input = document.getElementById("uploadFileInput");
  const btn = document.getElementById("uploadFileBtn");

  btn.addEventListener("click", () => {
    const file = input.files?.[0];
    if (!file) {
      alert("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
      return;
    }

    const reader = new FileReader();
    reader.onload = e => {
      try {
        const arr = JSON.parse(e.target.result);
        if (!Array.isArray(arr)) {
          alert("JSON í˜•ì‹ ì˜¤ë¥˜: ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤.");
          return;
        }

        const custom = loadCustomQuestions();
        arr.forEach(q => custom.push(q));
        saveCustomQuestions(custom);
        refreshChapterDropdown();

        alert(`${arr.length} ë¬¸ì œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      } catch (err) {
        alert("JSON íŒŒì‹± ì˜¤ë¥˜");
      }
    };

    reader.readAsText(file);
  });
}

/******************************************************************
 * 25. ì‚¬ìš©ì ë¬¸ì œ ê´€ë¦¬
 ******************************************************************/
function setupCustomManagement() {
  document.getElementById("clearCustomBtn").addEventListener("click", () => {
    if (!confirm("ì‚¬ìš©ì ìƒì„± ë¬¸ì œ ì „ì²´ ì‚­ì œ?")) return;
    saveCustomQuestions([]);
    refreshChapterDropdown();
  });

  document.getElementById("exportCustomBtn").addEventListener("click", () => {
    const data = loadCustomQuestions();
    const blob = new Blob([JSON.stringify(data, null, 2)], {
      type: "application/json"
    });

    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "cre_custom_questions.json";
    a.click();
  });
}

/******************************************************************
 * 26. 2ë‹¨ ë³´ê¸° ìŠ¤ìœ„ì¹˜
 ******************************************************************/
function setupDualToggle() {
  const cb = document.getElementById("dualViewToggle");
  dualView = cb.checked;

  cb.addEventListener("change", () => {
    dualView = cb.checked;
    if (currentQuiz.length) renderQuiz();
  });
}

/******************************************************************
 * 27. ì´ˆê¸° ì‹¤í–‰ (í˜ì´ì§€ ë¡œë”© ì‹œ ì‹¤í–‰)
 ******************************************************************/
window.addEventListener("DOMContentLoaded", () => {
  setupGate();
  setupAddQuestionForm();
  setupUploadQuestions();
  setupCustomManagement();
  setupDualToggle();

  // ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
  document.getElementById("startBtn").addEventListener("click", startQuiz);
  document.getElementById("resetBtn").addEventListener("click", resetQuiz);

  document.getElementById("submitBtn").addEventListener("click", () => {
    submitQuiz(false);
  });

  document.getElementById("clearWrongBtn").addEventListener("click", clearWrongNotes);
  document.getElementById("clearScoreBtn").addEventListener("click", clearScoreHistory);
});
</script>
<!-- â–²â–²â–² PART 4 ë â–²â–²â–² -->

</body>
</html>
