<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>CRE Practice CBT</title>

<style>
  body {
    font-family: Arial, system-ui, sans-serif;
    margin: 0;
    padding: 0;
    background:#f2f4f7;
  }

  .container {
    max-width: 1100px;
    margin: 20px auto;
    background:#fff;
    border-radius:10px;
    padding:20px 24px 40px;
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
    display:none;
  }

  h1 { margin-top:0; }

  .controls {
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    margin-bottom:16px;
    padding:12px;
    background:#f7f9fc;
    border-radius:8px;
  }

  .controls > div { min-width: 180px; }

  label {
    font-size:14px;
    font-weight:600;
    display:block;
    margin-bottom:4px;
  }

  select, input[type="number"], input[type="text"], textarea {
    width:100%;
    padding:6px 8px;
    font-size:14px;
    box-sizing:border-box;
  }

  button {
    padding:8px 14px;
    font-size:14px;
    cursor:pointer;
    border-radius:6px;
    border:1px solid #1f6feb;
    background:#1f6feb;
    color:#fff;
  }

  button.secondary {
    background:#fff;
    color:#1f2933;
    border-color:#cbd2e1;
  }

  button:disabled {
    opacity:0.6;
    cursor:not-allowed;
  }

  #timer {
    font-size:18px;
    font-weight:bold;
    color:#e11d48;
  }

  .question-block {
    margin-bottom:20px;
    padding-bottom:12px;
    border-bottom:1px solid #e5e7eb;
  }

  .question-title {
    font-weight:bold;
    margin-bottom:8px;
  }

  .meta {
    font-size:12px;
    color:#6b7280;
    margin-bottom:4px;
  }

  /* ----------------- 2ë‹¨ ë³´ê¸° ------------------ */
  .question-block.dual { display:flex; gap:16px; }
  .q-left, .q-right { width:50%; }
  .q-right {
    border-left:1px solid #e5e7eb;
    padding-left:14px;
    font-size:13px;
    color:#374151;
  }

  #resultBox {
    margin-top:24px;
    padding:16px;
    border-radius:8px;
    background:#ecfeff;
    border:1px solid #7dd3fc;
  }

  /* íƒœê·¸ */
  .tag { display:inline-block; font-size:11px; padding:1px 6px; border-radius:999px; margin-left:4px; background:#e5e7eb; }
  .tag.A { background:#dbeafe; }
  .tag.C { background:#fef3c7; }

  /* ë¹„ë°€ë²ˆí˜¸ ê²Œì´íŠ¸ */
  #gateOverlay {
    position:fixed; inset:0; background:rgba(15,23,42,0.92);
    display:flex; align-items:center; justify-content:center;
    z-index:9999;
  }
  #gateBox {
    background:#f9fafb; padding:24px 26px; width:320px; 
    border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,0.4);
  }
  #gateMessage {
    font-size:12px;
    height:16px;
    color:#dc2626;
    margin-top:6px;
  }
</style>
</head>

<body>

<!-- ë¹„ë°€ë²ˆí˜¸ ê²Œì´íŠ¸ -->
<div id="gateOverlay">
  <div id="gateBox">
    <h2>CRE ì—°ìŠµ ì‚¬ì´íŠ¸</h2>
    <p style="font-size:13px;color:#4b5563;">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
    <input type="password" id="gatePassword" placeholder="ë¹„ë°€ë²ˆí˜¸" />
    <div id="gateMessage"></div>
    <button id="gateBtn">ì…ì¥</button>
  </div>
</div>


<!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
<div class="container" id="appContainer">
  <h1>CRE Practice CBT</h1>
  <p style="font-size:13px;color:#4b5563;">
    PC Â· ëª¨ë°”ì¼ ì™„ì „ ë™ê¸°í™” ì‹œí—˜ ì‹œìŠ¤í…œ
  </p>
<!-- ================================
     PART 2 â€” Firebase + ë²ˆì—­ì—”ì§„ + ë¬¸ì œ ìë™ ë³‘í•©
================================ -->

<script>
/*******************************************************
 * 1) Firebase ì´ˆê¸°í™”
 *******************************************************/
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/*******************************************************
 * 2) deviceId = ê³ ì •ê°’ (ëª¨ë“  ê¸°ê¸° ë™ì¼í•˜ê²Œ ê³µìœ )
 *******************************************************/
const deviceId = "CRE_MASTER_DEVICE";  
function userPath() {
  return `users/${deviceId}`;
}

/*******************************************************
 * 3) ìë™ ë²ˆì—­ ì—”ì§„ (ì‹œí—˜ ë¬¸ì œ íŒ¨í„´ ê¸°ë°˜)
 *******************************************************/
function translateTech(text) {
  if (!text) return "";
  let out = text;

  const dict = {
    "reliability": "ì‹ ë¢°ë„",
    "failure rate": "ê³ ì¥ë¥ ",
    "hazard rate": "ìœ„í—˜ë¥ ",
    "MTBF": "í‰ê· ê³ ì¥ê°„ê²©(MTBF)",
    "MTTR": "í‰ê· ìˆ˜ë¦¬ì‹œê°„(MTTR)",
    "exponential distribution": "ì§€ìˆ˜ë¶„í¬",
    "weibull": "ì™€ì´ë¸” ë¶„í¬",
    "weibull distribution": "ì™€ì´ë¸” ë¶„í¬",
    "availability": "ê°€ìš©ë„",
    "preventive maintenance": "ì˜ˆë°©ì •ë¹„"
  };

  for (const [en, ko] of Object.entries(dict)) {
    const reg = new RegExp(en, "gi");
    out = out.replace(reg, `${ko} (${en})`);
  }
  return out;
}

function translateSentence(text) {
  if (!text) return "";
  let t = text;

  t = t.replace(/Which of the following/gi, "ë‹¤ìŒ ì¤‘");
  t = t.replace(/Which is NOT/gi, "ë‹¤ìŒ ì¤‘ ì˜³ì§€ ì•Šì€ ê²ƒì€");
  t = t.replace(/What is/gi, "ë¬´ì—‡ì€");
  t = t.replace(/\?/g, "ì¸ê°€?");

  return t;
}

/*******************************************************
 * 4) ë¬¸ì œ ì—”ì§„ â€” BASE ë¬¸ì œ
 *******************************************************/
let BASE_QUESTIONS = [];

async function loadBaseQuestions() {
  // ê¸°ë³¸ ì˜ˆì‹œ 2ë¬¸ì œ (ë‚˜ì¤‘ì—ëŠ” ëª¨ë‘ JSON ê¸°ë°˜ìœ¼ë¡œ í™•ì¥ë¨)
  BASE_QUESTIONS = [
    {
      id: "Q1",
      chapter: "Sample",
      type: "C",
      text: "For an exponential distribution with MTBF = 800 hours, what is the reliability at 400 hours?",
      options: ["0.50", "0.61", "0.37", "0.80"],
      answer: 1,
      explanation: "R(t) = exp(-t/MTBF) = exp(-0.5) = 0.606"
    },
    {
      id: "Q2",
      chapter: "Sample",
      type: "A",
      text: "In a Weibull distribution, what does a shape parameter Î² greater than 1 indicate?",
      options: ["Early failures", "Wear-out failures", "Constant failure rate", "Random failures"],
      answer: 1,
      explanation: "Î² > 1 â†’ wear-out region"
    }
  ];
}

/*******************************************************
 * 5) questions í´ë” ìë™ ìŠ¤ìº”
 *   - GitHub PagesëŠ” directory listing ë¶ˆê°€ â†’ question-list.json í•„ìš”
 *******************************************************/
let CUSTOM_QUESTIONS = [];
let MERGED_QUESTIONS = [];

async function autoLoadQuestionFiles() {
  try {
    const res = await fetch("./questions/question-list.json");
    const list = await res.json();   // ["set1.json", "cre1.json", ...]

    CUSTOM_QUESTIONS = [];

    for (const file of list) {
      try {
        const r = await fetch("./questions/" + file);
        const arr = await r.json();

        if (Array.isArray(arr)) {
          CUSTOM_QUESTIONS.push(...arr);
        }
      } catch (e) {
        console.warn("âš  ë¬¸ì œíŒŒì¼ ë¡œë“œ ì‹¤íŒ¨:", file);
      }
    }

    console.log("ğŸ“˜ ì»¤ìŠ¤í…€ ë¬¸ì œ ë¡œë“œ ì™„ë£Œ:", CUSTOM_QUESTIONS.length);

  } catch (e) {
    console.warn("âš  question-list.json ì—†ìŒ â†’ custom ë¬¸ì œ 0ê°œ");
  }
}

/*******************************************************
 * 6) ì „ì²´ ë¬¸ì œ ë³‘í•©
 *******************************************************/
function mergeQuestions() {
  MERGED_QUESTIONS = [...BASE_QUESTIONS, ...CUSTOM_QUESTIONS];
  console.log("ğŸ“š ì „ì²´ ë¬¸ì œ ë³‘í•© ì™„ë£Œ:", MERGED_QUESTIONS.length);
}

/*******************************************************
 * 7) ì±•í„° ëª©ë¡ ìƒì„±
 *******************************************************/
function buildChapterList() {
  const chapters = new Set(["ì „ì²´"]);
  MERGED_QUESTIONS.forEach(q => chapters.add(q.chapter));

  let html = "";
  chapters.forEach(c => {
    html += `<option value="${c}">${c}</option>`;
  });

  document.getElementById("chapterSelect").innerHTML = html;
}

/*******************************************************
 * 8) 2ë‹¨ ë³´ê¸°(ì˜/í•œ) â€” í•œê¸€ íŒ¨ë„
 *******************************************************/
function buildKoreanPanel(q, idx) {
  return `
    <div class="ko-header">Q${idx + 1} â€” í•œê¸€ ë²ˆì—­</div>

    <div class="ko-label">ê¸°ìˆ  ë²ˆì—­</div>
    <div>${translateTech(q.text)}</div>

    <div class="ko-label" style="margin-top:6px;">ë¬¸ì¥ ë²ˆì—­</div>
    <div>${translateSentence(q.text)}</div>

    <div class="ko-label" style="margin-top:6px;">ë³´ê¸° ë²ˆì—­</div>
    ${
      q.options.map((op, i)=>`
        <div class="ko-option">
          <b>${String.fromCharCode(65+i)}.</b>
          ${translateTech(op)}
        </div>
      `).join("")
    }
  `;
}
</script>
<!-- ================================
     PART 3 â€” ì˜¤ë‹µë…¸íŠ¸Â·ì ìˆ˜ê¸°ë¡ ë™ê¸°í™” + ì¦ê²¨ì°¾ê¸° + ë©”ëª¨
================================ -->
<script>
/*******************************************************
 * 1) ì˜¤ë‹µë…¸íŠ¸ + ì ìˆ˜ê¸°ë¡ ë³€ìˆ˜ë¥¼ ë©”ëª¨ë¦¬ì— ìœ ì§€
 *******************************************************/
let wrongNotes = [];      // [{id, text, chapter, type, missCount, lastDate}]
let scoreHistory = [];    // [{date, correct, total}]
let favoriteMap = {};     // {"Q1":true, "Q2":true ...}
let memoCache = {};       // {"Q1":"ë©”ëª¨ë‚´ìš©", ...}


/*******************************************************
 * 2) Firestore ë¡œë“œ â€” ì˜¤ë‹µë…¸íŠ¸
 *******************************************************/
async function loadWrongNotesFromCloud() {
  wrongNotes = [];
  const snap = await db.collection(`${userPath()}/wrongNotes`).get();
  snap.forEach(doc => wrongNotes.push(doc.data()));

  console.log("ğŸ“¥ ì˜¤ë‹µë…¸íŠ¸ ë¡œë“œ:", wrongNotes.length);
}

/*******************************************************
 * 3) Firestore ë¡œë“œ â€” ì ìˆ˜ ê¸°ë¡
 *******************************************************/
async function loadScoreHistoryFromCloud() {
  scoreHistory = [];
  const snap = await db.collection(`${userPath()}/scores`).get();
  snap.forEach(doc => scoreHistory.push(doc.data()));

  console.log("ğŸ“¥ ì ìˆ˜ê¸°ë¡ ë¡œë“œ:", scoreHistory.length);
}

/*******************************************************
 * 4) Firestore ë¡œë“œ â€” ì¦ê²¨ì°¾ê¸°
 *******************************************************/
async function loadFavorites() {
  favoriteMap = {};
  const snap = await db.collection(`${userPath()}/favorites`).get();
  snap.forEach(doc => favoriteMap[doc.id] = true);

  console.log("â­ ì¦ê²¨ì°¾ê¸° ë¡œë“œ:", Object.keys(favoriteMap).length);
}

/*******************************************************
 * 5) Firestore ë¡œë“œ â€” ë©”ëª¨
 *******************************************************/
async function loadAllMemos() {
  memoCache = {};
  const snap = await db.collection(`${userPath()}/notes`).get();
  snap.forEach(doc => memoCache[doc.id] = doc.data().memo);

  console.log("ğŸ“ ë©”ëª¨ ë¡œë“œ:", Object.keys(memoCache).length);
}


/*******************************************************
 * 6) Firestore ì €ì¥ â€” ì˜¤ë‹µë…¸íŠ¸
 *******************************************************/
async function saveWrongNotesToCloud() {
  for (const w of wrongNotes) {
    await db.collection(`${userPath()}/wrongNotes`)
      .doc(w.id)
      .set(w);
  }
}

/*******************************************************
 * 7) Firestore ì €ì¥ â€” ì ìˆ˜ ê¸°ë¡
 *******************************************************/
async function saveScoreHistoryToCloud() {
  for (const s of scoreHistory) {
    const key = s.date.replace(/[ :]/g, "_");
    await db.collection(`${userPath()}/scores`)
      .doc(key)
      .set(s);
  }
}

/*******************************************************
 * 8) Firestore ì €ì¥ â€” ì¦ê²¨ì°¾ê¸° Toggle
 *******************************************************/
async function toggleFavorite(q) {
  const ref = db.collection(`${userPath()}/favorites`).doc(q.id);

  if (favoriteMap[q.id]) {
    await ref.delete();
    delete favoriteMap[q.id];
  } else {
    await ref.set({
      id: q.id,
      text: q.text,
      chapter: q.chapter,
      type: q.type,
      star: true
    });
    favoriteMap[q.id] = true;
  }

  renderQuiz();
}

/*******************************************************
 * 9) Firestore ì €ì¥ â€” ë©”ëª¨
 *******************************************************/
async function saveMemoContents(qid, memoText) {
  memoCache[qid] = memoText;

  await db.collection(`${userPath()}/notes`)
    .doc(qid)
    .set({
      id: qid,
      memo: memoText,
      updateTime: new Date().toLocaleString()
    });
}


/*******************************************************
 * 10) UI â€” ë©”ëª¨ ëª¨ë‹¬
 *******************************************************/
function openMemo(qid) {
  const modal = document.getElementById("memoModal");
  const input = document.getElementById("memoInput");
  const label = document.getElementById("memoQuestionId");

  label.textContent = "ë¬¸ì œ ID: " + qid;
  input.value = memoCache[qid] || "";

  modal.style.display = "flex";
  modal.dataset.qid = qid;
}

function closeMemo() {
  document.getElementById("memoModal").style.display = "none";
}

async function saveMemo() {
  const modal = document.getElementById("memoModal");
  const qid = modal.dataset.qid;
  const memoText = document.getElementById("memoInput").value.trim();

  await saveMemoContents(qid, memoText);

  alert("ë©”ëª¨ ì €ì¥ë¨");
  closeMemo();
}


/*******************************************************
 * 11) ë¬¸ì œ ì¶œë ¥ ì—”ì§„ (PART 3 í™•ì¥)
 *******************************************************/
let currentQuiz = [];
let dualView = false;

function renderQuiz() {
  const box = document.getElementById("quizBox");
  box.innerHTML = "";

  currentQuiz.forEach((q, idx) => {

    // â­ ì¦ê²¨ì°¾ê¸° ì•„ì´ì½˜
    const star = favoriteMap[q.id] ? "â­" : "â˜†";
    const starColor = favoriteMap[q.id] ? "color:#fbbf24;" : "color:#94a3b8;";
    const starBtn = `
      <span style="float:right; font-size:20px; cursor:pointer; ${starColor}"
            onclick="toggleFavorite(currentQuiz[${idx}])">
        ${star}
      </span>`;

    // ğŸ“ ë©”ëª¨ ë²„íŠ¼
    const memoBtn = `
      <span style="float:right; margin-right:8px; cursor:pointer; font-size:18px; color:#3b82f6;"
            onclick="openMemo('${q.id}')">ğŸ“</span>`;

    /* ---------- ì˜ì–´ ì „ìš© ë³´ê¸° ---------- */
    if (!dualView) {
      let html = `
        <div class="question-block">
          ${starBtn} ${memoBtn}
          <div class="question-title">Q${idx + 1}. ${q.text}</div>
          <div class="meta">${q.id} Â· ${q.chapter} Â· ${q.type}</div>
      `;
      q.options.forEach((op, j) => {
        html += `
          <div class="option">
            <label>
              <input type="radio" name="q${idx}" value="${j}">
              ${String.fromCharCode(65 + j)}. ${op}
            </label>
          </div>`;
      });
      html += `</div>`;
      box.innerHTML += html;
      return;
    }

    /* ---------- 2ë‹¨ ë³´ê¸°(ì˜/í•œ) ---------- */
    let left = `
      <div class="q-left">
        ${starBtn} ${memoBtn}
        <div class="question-title">Q${idx + 1}. ${q.text}</div>
        <div class="meta">${q.id} Â· ${q.chapter} Â· ${q.type}</div>
    `;
    q.options.forEach((op, j) => {
      left += `
        <div class="option">
          <label>
            <input type="radio" name="q${idx}" value="${j}">
            ${String.fromCharCode(65 + j)}. ${op}
          </label>
        </div>`;
    });
    left += `</div>`;

    const right = `
      <div class="q-right">
        ${buildKoreanPanel(q, idx)}
      </div>`;

    box.innerHTML += `
      <div class="question-block dual">
        ${left}${right}
      </div>`;
  });
}


/*******************************************************
 * 12) ì¶œì œ ëª¨ë“œ í•„í„°
 *******************************************************/
function buildQuestionPool() {
  const ch = document.getElementById("chapterSelect").value;
  const tp = document.getElementById("typeSelect").value;
  const mode = document.getElementById("modeSelect").value;

  let list = MERGED_QUESTIONS;

  // ì±•í„° í•„í„°
  if (ch !== "ì „ì²´") list = list.filter(q => q.chapter === ch);

  // ìœ í˜• í•„í„°
  if (tp !== "all") list = list.filter(q => q.type === tp);

  // ëª¨ë“œ í•„í„°
  if (mode === "favorite") {
    const fav = new Set(Object.keys(favoriteMap));
    list = list.filter(q => fav.has(q.id));
  }
  if (mode === "wrong") {
    const wrongIds = new Set(wrongNotes.map(n => n.id));
    list = list.filter(q => wrongIds.has(q.id));
  }

  return list;
}


/*******************************************************
 * 13) íƒ€ì´ë¨¸
 *******************************************************/
let timerId = null;
let timerSec = 0;

function startTimer(sec) {
  timerSec = sec;
  updateTimerUI();
  if (timerId) clearInterval(timerId);

  timerId = setInterval(() => {
    timerSec--;
    updateTimerUI();
    if (timerSec <= 0) {
      clearInterval(timerId);
      alert("ì‹œê°„ ì¢…ë£Œ! ìë™ ì œì¶œí•©ë‹ˆë‹¤.");
      submitQuiz();
    }
  }, 1000);
}

function updateTimerUI() {
  const box = document.getElementById("timer");
  if (timerSec <= 0) {
    box.textContent = "Timer: OFF";
    return;
  }
  const m = String(Math.floor(timerSec / 60)).padStart(2, "0");
  const s = String(timerSec % 60).padStart(2, "0");
  box.textContent = `ë‚¨ì€ ì‹œê°„: ${m}:${s}`;
}


/*******************************************************
 * 14) ì‹œí—˜ ì‹œì‘
 *******************************************************/
function startQuiz() {
  const pool = buildQuestionPool();
  if (!pool.length) {
    alert("ì¶œì œí•  ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const count = Number(document.getElementById("countInput").value);
  const tm = Number(document.getElementById("timerInput").value);

  const shuffled = pool.sort(() => Math.random() - 0.5);
  currentQuiz = shuffled.slice(0, count);

  renderQuiz();

  document.getElementById("resultBox").innerHTML = "";
  document.getElementById("submitBtn").disabled = false;
  document.getElementById("resetBtn").disabled = false;

  if (tm > 0) startTimer(tm * 60);
}


/*******************************************************
 * 15) ì œì¶œ + ì˜¤ë‹µ ì €ì¥ + ì ìˆ˜ ì €ì¥
 *******************************************************/
function submitQuiz() {
  if (!currentQuiz.length) return;

  clearInterval(timerId);

  let correct = 0;
  const wrongArr = [];

  let html = "";

  currentQuiz.forEach((q, idx) => {
    const sel = document.querySelector(`input[name="q${idx}"]:checked`);
    const ans = sel ? Number(sel.value) : null;
    const ok = ans === q.answer;

    if (ok) correct++;
    else wrongArr.push(q);

    html += `
      <div style="margin-bottom:12px;">
        <b>Q${idx + 1} (${q.id})</b><br>
        ì„ íƒ: ${
          ans === null
            ? "ë¬´ì‘ë‹µ"
            : `${String.fromCharCode(65 + ans)}. ${q.options[ans]}`
        }<br>
        ì •ë‹µ:
        <span style="color:${ok ? "#16a34a" : "#dc2626"}">
          ${String.fromCharCode(65 + q.answer)}. ${q.options[q.answer]}
        </span>
      </div>`;
  });

  const pct = Math.round((correct / currentQuiz.length) * 100);
  document.getElementById("resultBox").innerHTML =
    `<h3>ì ìˆ˜: ${correct}/${currentQuiz.length} (${pct}%)</h3>` + html;

  saveWrong(wrongArr);
  saveScore(correct, currentQuiz.length);
}

function saveWrong(arr) {
  const now = new Date().toLocaleString();

  arr.forEach(q => {
    const exist = wrongNotes.find(n => n.id === q.id);

    if (exist) {
      exist.missCount++;
      exist.lastDate = now;
    } else {
      wrongNotes.push({
        id: q.id,
        text: q.text,
        chapter: q.chapter,
        type: q.type,
        missCount: 1,
        lastDate: now
      });
    }
  });

  saveWrongNotesToCloud();
}

function saveScore(correct, total) {
  scoreHistory.push({
    date: new Date().toLocaleString(),
    correct,
    total
  });
  saveScoreHistoryToCloud();
}
</script>
<!-- ================================
     PART 4 â€” UI ì „ì²´ êµ¬ì¡°
================================ -->

<!-- ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
<div class="controls">

  <div>
    <label>ì±•í„° ì„ íƒ</label>
    <select id="chapterSelect">
      <option>ì „ì²´</option>
    </select>
  </div>

  <div>
    <label>ë¬¸ì œ ìœ í˜•</label>
    <select id="typeSelect">
      <option value="all">ì „ì²´</option>
      <option value="A">Aí˜•</option>
      <option value="C">Cí˜•</option>
    </select>
  </div>

  <div>
    <label>ëª¨ë“œ</label>
    <select id="modeSelect">
      <option value="normal">ì¼ë°˜ ì¶œì œ</option>
      <option value="wrong">ì˜¤ë‹µ ì§‘ì¤‘</option>
      <option value="favorite">ì¦ê²¨ì°¾ê¸°ë§Œ</option>
    </select>
  </div>

  <div>
    <label>ì¶œì œ ë¬¸ì œ ìˆ˜</label>
    <input id="countInput" type="number" value="20" min="1" />
  </div>

  <div>
    <label>íƒ€ì´ë¨¸(ë¶„)</label>
    <input id="timerInput" type="number" value="0" min="0" />
  </div>

  <div style="display:flex; align-items:flex-end;">
    <button id="startBtn">ì‹œí—˜ ì‹œì‘</button>
  </div>

  <div style="display:flex; align-items:flex-end;">
    <button id="submitBtn" disabled>ì œì¶œ</button>
  </div>

  <div style="display:flex; align-items:flex-end;">
    <button id="resetBtn" disabled class="secondary">ì´ˆê¸°í™”</button>
  </div>

  <div style="display:flex; align-items:flex-end; gap:6px;">
    <label style="margin:0;">2ë‹¨ ë³´ê¸°</label>
    <input type="checkbox" id="dualViewToggle" style="zoom:1.4; margin-left:4px;">
  </div>

</div>

<!-- íƒ€ì´ë¨¸ í‘œì‹œ -->
<div id="timer" style="font-weight:bold; margin-bottom:10px;">Timer: OFF</div>

<!-- ë©”ì¸ ë¬¸ì œ ì˜ì—­ -->
<div id="quizBox"></div>

<!-- ê²°ê³¼ ì¶œë ¥ ì˜ì—­ -->
<div id="resultBox"></div>

<!-- ì˜¤ë‹µë…¸íŠ¸ & ì ìˆ˜ ê¸°ë¡ íŒ¨ë„ -->
<div class="panel-row">

  <div class="panel">
    <h3>ì˜¤ë‹µ ë…¸íŠ¸</h3>
    <div id="wrongNotesBox"></div>
    <button class="danger" style="margin-top:6px;" onclick="clearWrongNotes()">ì˜¤ë‹µ ì‚­ì œ</button>
  </div>

  <div class="panel">
    <h3>ì ìˆ˜ ê¸°ë¡</h3>
    <div id="scoreHistoryBox"></div>
    <button class="danger" style="margin-top:6px;" onclick="clearScoreHistory()">ê¸°ë¡ ì‚­ì œ</button>
  </div>

</div>


<!-- ================================
     ë©”ëª¨ ëª¨ë‹¬
================================ -->
<div id="memoModal"
     style="
       display:none;
       position:fixed; inset:0;
       background:rgba(0,0,0,0.55);
       align-items:center;
       justify-content:center;
       z-index:99999;
     ">
  <div style="
       background:white;
       width:340px;
       padding:20px;
       border-radius:10px;
     ">
    
    <h3 id="memoQuestionId" style="margin-top:0; font-size:16px;"></h3>

    <textarea id="memoInput"
      style="width:100%; height:140px; padding:8px; font-size:14px;"></textarea>

    <div style="margin-top:12px; display:flex; gap:8px;">
      <button
        onclick="saveMemo()"
        style="flex:1; background:#3b82f6; border-color:#3b82f6; color:white;">
        ì €ì¥
      </button>

      <button onclick="closeMemo()" class="secondary" style="flex:1;">
        ë‹«ê¸°
      </button>
    </div>

  </div>
</div>

  <script>
/*******************************************************
 * PART 5 â€” ì „ì²´ ì•ˆì •í™” ë° UX ê°œì„ 
 *******************************************************/

/* ====================================================
   1) ë¡œë”© ìŠ¤í”¼ë„ˆ (ë¬¸ì œ ë¡œë”©/FireStore ë¡œë”© ì‹œ í‘œì‹œ)
==================================================== */
function showLoading(msg = "ë¡œë”© ì¤‘...") {
  let box = document.getElementById("loadingOverlay");
  if (!box) {
    box = document.createElement("div");
    box.id = "loadingOverlay";
    box.style = `
      position:fixed; inset:0; background:rgba(0,0,0,0.55);
      display:flex; align-items:center; justify-content:center;
      color:white; font-size:18px; z-index:999999;
    `;
    box.innerHTML = `
      <div style="text-align:center;">
        <div class="spinner"
             style="border:4px solid #ddd; border-top:4px solid #3b82f6;
                    width:40px; height:40px; border-radius:50%;
                    margin:auto; animation:spin 1s linear infinite;">
        </div>
        <div style="margin-top:10px;">${msg}</div>
      </div>`;
    document.body.appendChild(box);
  } else {
    box.querySelector("div div:last-child").textContent = msg;
    box.style.display = "flex";
  }
}

function hideLoading() {
  const box = document.getElementById("loadingOverlay");
  if (box) box.style.display = "none";
}

const spinStyle = document.createElement("style");
spinStyle.innerHTML = `
@keyframes spin { 
  0% {transform:rotate(0deg);} 
  100% {transform:rotate(360deg);} 
}`;
document.head.appendChild(spinStyle);


/* ====================================================
   2) JSON ë¬¸ì œíŒŒì¼ ì•ˆì „ ë¡œë”©(Fallback)
==================================================== */
async function safeFetchJSON(url) {
  try {
    const r = await fetch(url);
    if (!r.ok) throw new Error("404");
    return await r.json();
  } catch (e) {
    console.warn("âš  JSON ë¡œë“œ ì‹¤íŒ¨:", url);
    return null; // ê±´ë„ˆë›°ê¸°
  }
}


/* ====================================================
   3) ë¬¸ì œ ë Œë”ë§ í›„ ìë™ ìŠ¤í¬ë¡¤(UX)
==================================================== */
function scrollTopSmooth() {
  window.scrollTo({ top: 0, behavior: "smooth" });
}


/* ====================================================
   4) ì œì¶œ í›„ ì„ íƒì§€ ê°•ì¡° ìƒ‰ìƒ
==================================================== */
function highlightAnswers() {
  const blocks = document.querySelectorAll(".question-block");
  blocks.forEach((blk, idx) => {
    const q = currentQuiz[idx];
    const radios = blk.querySelectorAll("input[type=radio]");

    radios.forEach(r => {
      const v = Number(r.value);
      if (v === q.answer) {
        r.parentElement.style.color = "#16a34a";
        r.parentElement.style.fontWeight = "bold";
      } else {
        r.parentElement.style.color = "#dc2626aa";
      }
    });
  });
}


/* ====================================================
   5) ë©”ëª¨ ëª¨ë‹¬ ì• ë‹ˆë©”ì´ì…˜
==================================================== */
function openMemo(qid) {
  const modal = document.getElementById("memoModal");
  const input = document.getElementById("memoInput");
  const label = document.getElementById("memoQuestionId");

  input.value = memoCache[qid] || "";
  label.textContent = "ë¬¸ì œ ID: " + qid;
  modal.dataset.qid = qid;

  modal.style.display = "flex";
  modal.style.opacity = 0;
  setTimeout(() => (modal.style.opacity = 1), 20);
}

function closeMemo() {
  const modal = document.getElementById("memoModal");
  modal.style.opacity = 0;
  setTimeout(() => (modal.style.display = "none"), 200);
}


/* ====================================================
   6) 2ë‹¨ ë³´ê¸° ì „í™˜ ì‹œ fade íš¨ê³¼
==================================================== */
document.getElementById("dualViewToggle").addEventListener("change", () => {
  const qb = document.getElementById("quizBox");
  qb.style.opacity = 0;

  setTimeout(() => {
    dualView = !dualView;
    if (currentQuiz.length) renderQuiz();
    qb.style.opacity = 1;
  }, 200);
});


/* ====================================================
   7) ë²ˆì—­ ìºì‹± ì†ë„ ê°œì„ 
==================================================== */
const TRANS_CACHE = {};

function cachedTranslateSentence(t) {
  if (TRANS_CACHE[t]) return TRANS_CACHE[t];
  const v = translateSentence(t);
  TRANS_CACHE[t] = v;
  return v;
}


/* ====================================================
   8) Firestore ì‹¤íŒ¨ ì‹œ fallback ì²˜ë¦¬
==================================================== */
async function safeLoadFromCloud() {
  try {
    await loadWrongNotesFromCloud();
    await loadScoreHistoryFromCloud();
    await loadFavorites();
    await loadAllMemos();
  } catch (e) {
    alert("âš  Firestore ë¡œë”© ì‹¤íŒ¨ â†’ ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ë™ì‘í•©ë‹ˆë‹¤.");
  }
}

async function safeSaveWrong() {
  try {
    await saveWrongNotesToCloud();
  } catch (e) {
    alert("âš  ì˜¤ë‹µ ì €ì¥ ì‹¤íŒ¨ â†’ ì¸í„°ë„· í™•ì¸ í•„ìš”");
  }
}

async function safeSaveScore() {
  try {
    await saveScoreHistoryToCloud();
  } catch (e) {
    alert("âš  ì ìˆ˜ ì €ì¥ ì‹¤íŒ¨ â†’ ì¸í„°ë„· í™•ì¸ í•„ìš”");
  }
}


/* ====================================================
   9) ì „ì²´ ì´ˆê¸°í™” ë£¨í‹´
==================================================== */
async function initializeApp() {
  showLoading("ë¬¸ì œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");

  await loadBaseQuestions();       // ê¸°ë³¸ ë¬¸ì œ ë¡œë“œ
  await autoLoadQuestionFiles();   // questions/*.json ìë™ ìŠ¤ìº”
  mergeQuestions();                // ë³‘í•© ì „ì²´ ë¬¸ì œí’€
  buildChapterList();              // ì±•í„° ëª©ë¡ UI

  hideLoading();
}


/* ====================================================
   10) DOM ë¡œë”© ì™„ë£Œ â†’ ì‹œìŠ¤í…œ ì‹œì‘
==================================================== */
window.addEventListener("DOMContentLoaded", async () => {
  await initializeApp();
});
</script>

