<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CRE Practice CBT</title>
<style>
  body {
    font-family: Arial, system-ui, sans-serif;
    margin: 0;
    padding: 0;
    background:#f2f4f7;
  }
  .container {
    max-width: 1100px;
    margin: 20px auto;
    background:#fff;
    border-radius:10px;
    padding:20px 24px 40px;
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
    display:none;
  }
  h1 { margin-top:0; }
  .controls {
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    margin-bottom:16px;
    padding:12px;
    background:#f7f9fc;
    border-radius:8px;
  }
  .controls > div { min-width: 180px; }
  label {
    font-size:14px;
    font-weight:600;
    display:block;
    margin-bottom:4px;
  }
  select, input[type="number"], input[type="text"], textarea {
    width:100%;
    padding:6px 8px;
    font-size:14px;
    box-sizing:border-box;
  }
  button {
    padding:8px 14px;
    font-size:14px;
    cursor:pointer;
    border-radius:6px;
    border:1px solid #1f6feb;
    background:#1f6feb;
    color:#fff;
  }
  button.secondary {
    background:#fff;
    color:#1f2933;
    border-color:#cbd2e1;
  }
  button.danger {
    background:#e11d48;
    border-color:#e11d48;
    color:#fff;
  }
  button:disabled {
    opacity:0.6;
    cursor:not-allowed;
  }
  #timer {
    font-size:18px;
    font-weight:bold;
    color:#e11d48;
  }
  .question-block {
    margin-bottom:20px;
    padding-bottom:12px;
    border-bottom:1px solid #e5e7eb;
  }
  .question-title {
    font-weight:bold;
    margin-bottom:8px;
  }
  .meta {
    font-size:12px;
    color:#6b7280;
    margin-bottom:4px;
  }
  /* 2ë‹¨ ë³´ê¸° */
  .question-block.dual { display:flex; gap:16px; }
  .q-left, .q-right { width:50%; box-sizing:border-box; }
  .q-right {
    border-left:1px solid #e5e7eb;
    padding-left:14px;
    font-size:13px;
    color:#374151;
  }
  .ko-header {
    font-weight:bold;
    margin-bottom:4px;
    font-size:13px;
    color:#111827;
  }
  .ko-label {
    font-size:12px;
    font-weight:bold;
    color:#4b5563;
    margin-top:4px;
  }
  .ko-option {
    font-size:13px;
    margin:3px 0;
  }
  @media (max-width: 900px){
    .question-block.dual{ flex-direction:column; }
    .q-left,.q-right{ width:100%; }
    .q-right{
      border-left:none;
      border-top:1px solid #e5e7eb;
      padding-left:0;
      padding-top:8px;
    }
  }
  #resultBox {
    margin-top:24px;
    padding:16px;
    border-radius:8px;
    background:#ecfeff;
    border:1px solid #7dd3fc;
  }
  .panel-row {
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    margin-top:20px;
  }
  .panel {
    flex:1;
    min-width:260px;
    background:#f9fafb;
    border-radius:8px;
    padding:10px 12px;
    border:1px solid #e5e7eb;
    max-height:300px;
    overflow:auto;
  }
  .panel h3 {
    margin-top:0;
    font-size:15px;
  }
  .tag {
    display:inline-block;
    font-size:11px;
    padding:1px 6px;
    border-radius:999px;
    margin-left:4px;
    background:#e5e7eb;
  }
  .tag.A { background:#dbeafe; }
  .tag.C { background:#fef3c7; }

  /* Gate */
  #gateOverlay {
    position:fixed;
    inset:0;
    background:rgba(15,23,42,0.92);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:9999;
  }
  #gateBox {
    background:#f9fafb;
    padding:24px 26px;
    width:320px;
    border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,0.4);
  }
  #gateMessage {
    font-size:12px;
    height:16px;
    color:#dc2626;
    margin-top:6px;
  }
</style>
</head>
<body>

<!-- ë¹„ë°€ë²ˆí˜¸ ê²Œì´íŠ¸ -->
<div id="gateOverlay">
  <div id="gateBox">
    <h2>CRE ì—°ìŠµ ì‚¬ì´íŠ¸</h2>
    <p style="font-size:13px;color:#4b5563;">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
    <input type="password" id="gatePassword" placeholder="ë¹„ë°€ë²ˆí˜¸" />
    <div id="gateMessage"></div>
    <button id="gateBtn">ì…ì¥</button>
  </div>
</div>

<!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
<div class="container" id="appContainer">
  <h1>CRE Practice CBT</h1>
  <p style="font-size:13px;color:#4b5563;">PC Â· ëª¨ë°”ì¼ ì™„ì „ ë™ê¸°í™” ì‹œí—˜ ì‹œìŠ¤í…œ</p>

  <!-- ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
  <div class="controls">
    <div>
      <label>ì±•í„° ì„ íƒ</label>
      <select id="chapterSelect">
        <option>ì „ì²´</option>
      </select>
    </div>
    <div>
      <label>ë¬¸ì œ ìœ í˜•</label>
      <select id="typeSelect">
        <option value="all">ì „ì²´</option>
        <option value="A">Aí˜•</option>
        <option value="C">Cí˜•</option>
      </select>
    </div>
    <div>
      <label>ëª¨ë“œ</label>
      <select id="modeSelect">
        <option value="normal">ì¼ë°˜ ì¶œì œ</option>
        <option value="wrong">ì˜¤ë‹µ ì§‘ì¤‘</option>
        <option value="favorite">ì¦ê²¨ì°¾ê¸°ë§Œ</option>
      </select>
    </div>
    <div>
      <label>ì¶œì œ ë¬¸ì œ ìˆ˜</label>
      <input id="countInput" type="number" value="20" min="1" />
    </div>
    <div>
      <label>íƒ€ì´ë¨¸(ë¶„)</label>
      <input id="timerInput" type="number" value="0" min="0" />
    </div>
    <div style="display:flex; align-items:flex-end;">
      <button id="startBtn">ì‹œí—˜ ì‹œì‘</button>
    </div>
    <div style="display:flex; align-items:flex-end;">
      <button id="submitBtn" disabled>ì œì¶œ</button>
    </div>
    <div style="display:flex; align-items:flex-end;">
      <button id="resetBtn" disabled class="secondary">ì´ˆê¸°í™”</button>
    </div>
    <div style="display:flex; align-items:flex-end; gap:6px;">
      <label style="margin:0;">2ë‹¨ ë³´ê¸°</label>
      <input type="checkbox" id="dualViewToggle" style="zoom:1.4; margin-left:4px;">
    </div>
  </div>

  <div id="timer" style="font-weight:bold; margin-bottom:10px;">Timer: OFF</div>
  <div id="quizBox"></div>
  <div id="resultBox"></div>

  <div class="panel-row">
    <div class="panel">
      <h3>ì˜¤ë‹µ ë…¸íŠ¸</h3>
      <div id="wrongNotesBox"></div>
      <button class="danger" style="margin-top:6px;" onclick="clearWrongNotes()">ì˜¤ë‹µ ì‚­ì œ</button>
    </div>
    <div class="panel">
      <h3>ì ìˆ˜ ê¸°ë¡</h3>
      <div id="scoreHistoryBox"></div>
      <button class="danger" style="margin-top:6px;" onclick="clearScoreHistory()">ê¸°ë¡ ì‚­ì œ</button>
    </div>
  </div>

  <!-- ë©”ëª¨ ëª¨ë‹¬ -->
  <div id="memoModal" style="
       display:none; position:fixed; inset:0;
       background:rgba(0,0,0,0.55);
       align-items:center; justify-content:center;
       z-index:99999;">
    <div style="background:white; width:340px; padding:20px; border-radius:10px;">
      <h3 id="memoQuestionId" style="margin-top:0; font-size:16px;"></h3>
      <textarea id="memoInput"
        style="width:100%; height:140px; padding:8px; font-size:14px;"></textarea>
      <div style="margin-top:12px; display:flex; gap:8px;">
        <button onclick="saveMemo()" style="flex:1; background:#3b82f6; border-color:#3b82f6; color:white;">ì €ì¥</button>
        <button onclick="closeMemo()" class="secondary" style="flex:1;">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
</div><!-- /container -->

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
/*******************************************************
 * Config + Firebase init
 *******************************************************/
const APP_PASSWORD = "cre2025";

const firebaseConfig = {
  apiKey: "AIzaSyBYrsPIpbP7wBMJk8QrU9vUtF0JDhfn2C4",
  authDomain: "rd-cre-cbt-sync.firebaseapp.com",
  projectId: "rd-cre-cbt-sync",
  storageBucket: "rd-cre-cbt-sync.firebasestorage.app",
  messagingSenderId: "1085101263930",
  appId: "1:1085101263930:web:06d1339169b431b63e3903"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// í•˜ë‚˜ì˜ ê³ ì • deviceId â†’ ëª¨ë“  ê¸°ê¸° ì™„ì „ ê³µìœ 
const deviceId = "CRE_MASTER_DEVICE";
const userPath = () => `users/${deviceId}`;

/*******************************************************
 * Translator (pattern-based)
 *******************************************************/
function translateTech(text) {
  if (!text) return "";
  let out = text;
  const dict = {
    "reliability": "ì‹ ë¢°ë„",
    "failure rate": "ê³ ì¥ë¥ ",
    "hazard rate": "ìœ„í—˜ë¥ ",
    "MTBF": "í‰ê· ê³ ì¥ê°„ê²©(MTBF)",
    "MTTR": "í‰ê· ìˆ˜ë¦¬ì‹œê°„(MTTR)",
    "exponential distribution": "ì§€ìˆ˜ë¶„í¬",
    "weibull distribution": "ì™€ì´ë¸” ë¶„í¬",
    "weibull": "ì™€ì´ë¸” ë¶„í¬",
    "availability": "ê°€ìš©ë„",
    "preventive maintenance": "ì˜ˆë°©ì •ë¹„"
  };
  for (const [en, ko] of Object.entries(dict)) {
    const reg = new RegExp(en, "gi");
    out = out.replace(reg, `${ko} (${en})`);
  }
  return out;
}

function translateSentence(text) {
  if (!text) return "";
  let t = text;
  t = t.replace(/Which of the following/gi, "ë‹¤ìŒ ì¤‘");
  t = t.replace(/Which is NOT/gi, "ë‹¤ìŒ ì¤‘ ì˜³ì§€ ì•Šì€ ê²ƒì€");
  t = t.replace(/What is/gi, "ë¬´ì—‡ì€");
  t = t.replace(/\?/g, "ì¸ê°€?");
  return t;
}

/*******************************************************
 * Questions: base + auto-load (question-list.json)
 *******************************************************/
let BASE_QUESTIONS = [];
let CUSTOM_QUESTIONS = [];
let MERGED_QUESTIONS = [];

async function loadBaseQuestions() {
  BASE_QUESTIONS = [
    {
      id: "Q1",
      chapter: "Sample",
      type: "C",
      text: "For an exponential distribution with MTBF = 800 hours, what is the reliability at 400 hours?",
      options: ["0.50","0.61","0.37","0.80"],
      answer: 1,
      explanation: "R(t) = exp(-t/MTBF) = exp(-0.5) = 0.606"
    },
    {
      id: "Q2",
      chapter: "Sample",
      type: "A",
      text: "In a Weibull distribution, what does a shape parameter Î² greater than 1 indicate?",
      options: ["Early failures","Wear-out failures","Constant failure rate","Random failures"],
      answer: 1,
      explanation: "Î² > 1 â†’ wear-out region"
    }
  ];
}

async function autoLoadQuestionFiles() {
  CUSTOM_QUESTIONS = [];
  try {
    const res = await fetch("./questions/question-list.json");
    if (!res.ok) throw new Error("no list");
    const list = await res.json(); // ["sample-set.json", ...]
    for (const file of list) {
      try {
        const r = await fetch("./questions/" + file);
        if (!r.ok) continue;
        const arr = await r.json();
        if (Array.isArray(arr)) CUSTOM_QUESTIONS.push(...arr);
      } catch (e) {
        console.warn("íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨:", file);
      }
    }
  } catch (e) {
    console.warn("question-list.json ì—†ìŒ â†’ custom ë¬¸ì œ 0ê°œ");
  }
}

function mergeQuestions() {
  MERGED_QUESTIONS = [...BASE_QUESTIONS, ...CUSTOM_QUESTIONS];
  console.log("ì „ì²´ ë¬¸ì œ:", MERGED_QUESTIONS.length);
}

function buildChapterList() {
  const chapters = new Set(["ì „ì²´"]);
  MERGED_QUESTIONS.forEach(q => chapters.add(q.chapter));
  let html = "";
  chapters.forEach(c => {
    html += `<option value="${c}">${c}</option>`;
  });
  document.getElementById("chapterSelect").innerHTML = html;
}

function buildKoreanPanel(q, idx) {
  return `
    <div class="ko-header">Q${idx + 1} â€” í•œê¸€ ë²ˆì—­</div>
    <div class="ko-label">ê¸°ìˆ  ë²ˆì—­</div>
    <div>${translateTech(q.text)}</div>
    <div class="ko-label" style="margin-top:6px;">ë¬¸ì¥ ë²ˆì—­</div>
    <div>${translateSentence(q.text)}</div>
    <div class="ko-label" style="margin-top:6px;">ë³´ê¸° ë²ˆì—­</div>
    ${
      q.options.map((op, i) => `
        <div class="ko-option">
          <b>${String.fromCharCode(65 + i)}.</b> ${translateTech(op)}
        </div>
      `).join("")
    }
  `;
}

/*******************************************************
 * Cloud state (wrong notes / scores / favorites / memos)
 *******************************************************/
let wrongNotes = [];
let scoreHistory = [];
let favoriteMap = {};
let memoCache = {};

async function loadWrongNotesFromCloud() {
  wrongNotes = [];
  const snap = await db.collection(`${userPath()}/wrongNotes`).get();
  snap.forEach(doc => wrongNotes.push(doc.data()));
}

async function loadScoreHistoryFromCloud() {
  scoreHistory = [];
  const snap = await db.collection(`${userPath()}/scores`).get();
  snap.forEach(doc => scoreHistory.push(doc.data()));
}

async function loadFavorites() {
  favoriteMap = {};
  const snap = await db.collection(`${userPath()}/favorites`).get();
  snap.forEach(doc => { favoriteMap[doc.id] = true; });
}

async function loadAllMemos() {
  memoCache = {};
  const snap = await db.collection(`${userPath()}/notes`).get();
  snap.forEach(doc => { memoCache[doc.id] = doc.data().memo; });
}

async function saveWrongNotesToCloud() {
  try {
    const batch = db.batch();
    wrongNotes.forEach(w => {
      const ref = db.collection(`${userPath()}/wrongNotes`).doc(w.id);
      batch.set(ref, w);
    });
    await batch.commit();
  } catch (e) {
    console.warn("saveWrongNotesToCloud error", e);
  }
}

async function saveScoreHistoryToCloud() {
  try {
    const batch = db.batch();
    scoreHistory.forEach(s => {
      const key = s.date.replace(/[ :]/g, "_");
      const ref = db.collection(`${userPath()}/scores`).doc(key);
      batch.set(ref, s);
    });
    await batch.commit();
  } catch (e) {
    console.warn("saveScoreHistoryToCloud error", e);
  }
}

async function clearWrongNotes() {
  const col = db.collection(`${userPath()}/wrongNotes`);
  const snap = await col.get();
  const batch = db.batch();
  snap.forEach(d => batch.delete(d.ref));
  await batch.commit();
  wrongNotes = [];
  renderWrongNotes();
}

async function clearScoreHistory() {
  const col = db.collection(`${userPath()}/scores`);
  const snap = await col.get();
  const batch = db.batch();
  snap.forEach(d => batch.delete(d.ref));
  await batch.commit();
  scoreHistory = [];
  renderScoreHistory();
}

async function toggleFavorite(q) {
  const ref = db.collection(`${userPath()}/favorites`).doc(q.id);
  if (favoriteMap[q.id]) {
    await ref.delete();
    delete favoriteMap[q.id];
  } else {
    await ref.set({
      id: q.id,
      text: q.text,
      chapter: q.chapter,
      type: q.type,
      star: true
    });
    favoriteMap[q.id] = true;
  }
  renderQuiz();
}

async function saveMemoContents(qid, memoText) {
  memoCache[qid] = memoText;
  await db.collection(`${userPath()}/notes`).doc(qid).set({
    id: qid,
    memo: memoText,
    updateTime: new Date().toLocaleString()
  });
}

function renderWrongNotes() {
  const box = document.getElementById("wrongNotesBox");
  if (!wrongNotes.length) {
    box.innerHTML = '<div style="font-size:12px;color:#888;">ì˜¤ë‹µ ì—†ìŒ</div>';
    return;
  }
  box.innerHTML = wrongNotes.map(n => `
    <div class="note-item">
      <b>${n.id}</b> <span class="tag ${n.type}">${n.type}</span>
      <div>${n.text}</div>
      <div style="font-size:11px;color:#666;">
        ${n.chapter} Â· ${n.missCount}íšŒ Â· ${n.lastDate}
      </div>
    </div>
  `).join("");
}

function renderScoreHistory() {
  const box = document.getElementById("scoreHistoryBox");
  if (!scoreHistory.length) {
    box.innerHTML = '<div style="font-size:12px;color:#888;">ê¸°ë¡ ì—†ìŒ</div>';
    return;
  }
  box.innerHTML = scoreHistory.slice().reverse().map(h => `
    <div class="score-item">
      <b>${h.date}</b> â€” ${h.correct}/${h.total}
      (${Math.round((h.correct / h.total) * 100)}%)
    </div>
  `).join("");
}

/*******************************************************
 * Memo modal
 *******************************************************/
function openMemo(qid) {
  const modal = document.getElementById("memoModal");
  const input = document.getElementById("memoInput");
  const label = document.getElementById("memoQuestionId");

  label.textContent = "ë¬¸ì œ ID: " + qid;
  input.value = memoCache[qid] || "";

  modal.dataset.qid = qid;
  modal.style.display = "flex";
  modal.style.opacity = 0;
  setTimeout(() => { modal.style.opacity = 1; }, 20);
}

function closeMemo() {
  const modal = document.getElementById("memoModal");
  modal.style.opacity = 0;
  setTimeout(() => { modal.style.display = "none"; }, 200);
}

async function saveMemo() {
  const modal = document.getElementById("memoModal");
  const qid = modal.dataset.qid;
  const memoText = document.getElementById("memoInput").value.trim();
  await saveMemoContents(qid, memoText);
  alert("ë©”ëª¨ ì €ì¥ë¨");
  closeMemo();
}

/*******************************************************
 * Quiz rendering + modes
 *******************************************************/
let currentQuiz = [];
let dualView = false;

function renderQuiz() {
  const box = document.getElementById("quizBox");
  box.innerHTML = "";

  currentQuiz.forEach((q, idx) => {
    const star = favoriteMap[q.id] ? "â­" : "â˜†";
    const starColor = favoriteMap[q.id] ? "color:#fbbf24;" : "color:#94a3b8;";
    const starBtn = `
      <span style="float:right; font-size:20px; cursor:pointer; ${starColor}"
            onclick="toggleFavorite(currentQuiz[${idx}])">
        ${star}
      </span>`;
    const memoBtn = `
      <span style="float:right; margin-right:8px; cursor:pointer;
                   font-size:18px; color:#3b82f6;"
            onclick="openMemo('${q.id}')">ğŸ“</span>`;

    if (!dualView) {
      let html = `
        <div class="question-block">
          ${starBtn} ${memoBtn}
          <div class="question-title">Q${idx + 1}. ${q.text}</div>
          <div class="meta">${q.id} Â· ${q.chapter} Â· ${q.type}</div>
      `;
      q.options.forEach((op, j) => {
        html += `
          <div class="option">
            <label>
              <input type="radio" name="q${idx}" value="${j}">
              ${String.fromCharCode(65 + j)}. ${op}
            </label>
          </div>
        `;
      });
      html += `</div>`;
      box.innerHTML += html;
      return;
    }

    // 2ë‹¨ ë³´ê¸°
    let left = `
      <div class="q-left">
        ${starBtn} ${memoBtn}
        <div class="question-title">Q${idx + 1}. ${q.text}</div>
        <div class="meta">${q.id} Â· ${q.chapter} Â· ${q.type}</div>
    `;
    q.options.forEach((op, j) => {
      left += `
        <div class="option">
          <label>
            <input type="radio" name="q${idx}" value="${j}">
            ${String.fromCharCode(65 + j)}. ${op}
          </label>
        </div>
      `;
    });
    left += `</div>`;

    const right = `<div class="q-right">${buildKoreanPanel(q, idx)}</div>`;

    box.innerHTML += `
      <div class="question-block dual">
        ${left}${right}
      </div>
    `;
  });
}

function buildQuestionPool() {
  const ch = document.getElementById("chapterSelect").value;
  const tp = document.getElementById("typeSelect").value;
  const mode = document.getElementById("modeSelect").value;

  let list = MERGED_QUESTIONS;
  if (ch !== "ì „ì²´") list = list.filter(q => q.chapter === ch);
  if (tp !== "all") list = list.filter(q => q.type === tp);

  if (mode === "favorite") {
    const fav = new Set(Object.keys(favoriteMap));
    list = list.filter(q => fav.has(q.id));
  }
  if (mode === "wrong") {
    const wrongIds = new Set(wrongNotes.map(n => n.id));
    list = list.filter(q => wrongIds.has(q.id));
  }
  return list;
}

/*******************************************************
 * Timer + Start/Submit/Reset
 *******************************************************/
let timerId = null;
let timerSec = 0;

function startTimer(sec) {
  timerSec = sec;
  updateTimerUI();
  if (timerId) clearInterval(timerId);
  timerId = setInterval(() => {
    timerSec--;
    updateTimerUI();
    if (timerSec <= 0) {
      clearInterval(timerId);
      alert("ì‹œê°„ ì¢…ë£Œ! ìë™ ì œì¶œí•©ë‹ˆë‹¤.");
      submitQuiz();
    }
  }, 1000);
}

function updateTimerUI() {
  const el = document.getElementById("timer");
  if (timerSec <= 0) {
    el.textContent = "Timer: OFF";
    return;
  }
  const m = String(Math.floor(timerSec / 60)).padStart(2, "0");
  const s = String(timerSec % 60).padStart(2, "0");
  el.textContent = `ë‚¨ì€ ì‹œê°„: ${m}:${s}`;
}

function startQuiz() {
  const pool = buildQuestionPool();
  if (!pool.length) {
    alert("ì¶œì œí•  ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  const count = Number(document.getElementById("countInput").value);
  const tm = Number(document.getElementById("timerInput").value);

  const shuffled = pool.slice().sort(() => Math.random() - 0.5);
  currentQuiz = shuffled.slice(0, count);

  renderQuiz();
  document.getElementById("resultBox").innerHTML = "";
  document.getElementById("submitBtn").disabled = false;
  document.getElementById("resetBtn").disabled = false;

  if (tm > 0) startTimer(tm * 60);
}

function submitQuiz() {
  if (!currentQuiz.length) return;
  if (timerId) clearInterval(timerId);

  let correct = 0;
  const wrongArr = [];
  let html = "";

  currentQuiz.forEach((q, idx) => {
    const sel = document.querySelector(`input[name="q${idx}"]:checked`);
    const ans = sel ? Number(sel.value) : null;
    const ok = ans === q.answer;
    if (ok) correct++;
    else wrongArr.push(q);

    html += `
      <div style="margin-bottom:12px;">
        <b>Q${idx + 1} (${q.id})</b><br>
        ì„ íƒ: ${
          ans === null
            ? "ë¬´ì‘ë‹µ"
            : `${String.fromCharCode(65 + ans)}. ${q.options[ans]}`
        }<br>
        ì •ë‹µ:
        <span style="color:${ok ? "#16a34a" : "#dc2626"}">
          ${String.fromCharCode(65 + q.answer)}. ${q.options[q.answer]}
        </span>
        <div class="explanation">${q.explanation || ""}</div>
      </div>
    `;
  });

  const pct = Math.round((correct / currentQuiz.length) * 100);
  document.getElementById("resultBox").innerHTML =
    `<h3>ì ìˆ˜: ${correct}/${currentQuiz.length} (${pct}%)</h3>` + html;

  saveWrong(wrongArr);
  saveScore(correct, currentQuiz.length);
  renderWrongNotes();
  renderScoreHistory();
}

function saveWrong(arr) {
  const now = new Date().toLocaleString();
  arr.forEach(q => {
    const exist = wrongNotes.find(n => n.id === q.id);
    if (exist) {
      exist.missCount++;
      exist.lastDate = now;
    } else {
      wrongNotes.push({
        id: q.id,
        text: q.text,
        chapter: q.chapter,
        type: q.type,
        missCount: 1,
        lastDate: now
      });
    }
  });
  saveWrongNotesToCloud();
}

function saveScore(correct, total) {
  scoreHistory.push({
    date: new Date().toLocaleString(),
    correct,
    total
  });
  saveScoreHistoryToCloud();
}

function resetQuiz() {
  if (timerId) clearInterval(timerId);
  currentQuiz = [];
  document.getElementById("quizBox").innerHTML = "";
  document.getElementById("resultBox").innerHTML = "";
  document.getElementById("submitBtn").disabled = true;
  document.getElementById("resetBtn").disabled = true;
  document.getElementById("timer").textContent = "Timer: OFF";
}

/*******************************************************
 * UX helpers
 *******************************************************/
function showLoading(msg = "ë¡œë”© ì¤‘...") {
  let box = document.getElementById("loadingOverlay");
  if (!box) {
    box = document.createElement("div");
    box.id = "loadingOverlay";
    box.style = "position:fixed; inset:0; background:rgba(0,0,0,0.55); display:flex; align-items:center; justify-content:center; color:white; font-size:18px; z-index:999999;";
    box.innerHTML = `
      <div style="text-align:center;">
        <div class="spinner"
             style="border:4px solid #ddd; border-top:4px solid #3b82f6;
                    width:40px; height:40px; border-radius:50%;
                    margin:auto; animation:spin 1s linear infinite;"></div>
        <div style="margin-top:10px;">${msg}</div>
      </div>`;
    document.body.appendChild(box);
  } else {
    box.querySelector("div div:last-child").textContent = msg;
    box.style.display = "flex";
  }
}

function hideLoading() {
  const box = document.getElementById("loadingOverlay");
  if (box) box.style.display = "none";
}

const spinStyle = document.createElement("style");
spinStyle.innerHTML = "@keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}";
document.head.appendChild(spinStyle);

async function initializeApp() {
  showLoading("ë¬¸ì œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
  await loadBaseQuestions();
  await autoLoadQuestionFiles();
  mergeQuestions();
  buildChapterList();
  hideLoading();
}

function wireUI() {
  document.getElementById("startBtn").addEventListener("click", startQuiz);
  document.getElementById("submitBtn").addEventListener("click", submitQuiz);
  document.getElementById("resetBtn").addEventListener("click", resetQuiz);
  document.getElementById("dualViewToggle").addEventListener("change", () => {
    const qb = document.getElementById("quizBox");
    qb.style.opacity = 0;
    setTimeout(() => {
      dualView = !dualView;
      if (currentQuiz.length) renderQuiz();
      qb.style.opacity = 1;
    }, 200);
  });
}

/*******************************************************
 * Gate + app start
 *******************************************************/
function setupGate() {
  const overlay = document.getElementById("gateOverlay");
  const app      = document.getElementById("appContainer");
  const input    = document.getElementById("gatePassword");
  const msg      = document.getElementById("gateMessage");
  const btn      = document.getElementById("gateBtn");

  async function enter() {
    if (input.value !== APP_PASSWORD) {
      msg.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
      return;
    }

    overlay.style.display = "none";
    app.style.display = "block";

    // 1) ë¬¸ì œ ë¡œë”© (ë¡œì»¬)
    await initializeApp();

    // 2) í´ë¼ìš°ë“œ ë™ê¸°í™”ëŠ” ì‹œë„ë§Œ í•˜ê³ , ì‹¤íŒ¨í•´ë„ ê·¸ëƒ¥ ë¡œì»¬ë¡œ ì§„í–‰
    try {
      await Promise.all([
        loadWrongNotesFromCloud(),
        loadScoreHistoryFromCloud(),
        loadFavorites(),
        loadAllMemos()
      ]);
    } catch (e) {
      console.warn("Firestore load error:", e);
      alert("í´ë¼ìš°ë“œ ë™ê¸°í™”ì— ì‹¤íŒ¨í•´ì„œ, ì§€ê¸ˆì€ ì´ ê¸°ê¸°ì—ì„œë§Œ ê¸°ë¡ì´ ì €ì¥ë©ë‹ˆë‹¤.");
      wrongNotes   = [];
      scoreHistory = [];
      favoriteMap  = {};
      memoCache    = {};
    }

    renderWrongNotes();
    renderScoreHistory();
    wireUI();   // â˜… ì´ê±´ ë¬´ì¡°ê±´ ì‹¤í–‰
  }

  btn.addEventListener("click", enter);
  input.addEventListener("keydown", (e) => { if (e.key === "Enter") enter(); });
}



document.addEventListener("DOMContentLoaded", () => {
  setupGate();
});
</script>

</body>
</html>
