
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>CRE Practice CBT (Cloud Sync Version)</title>

<!-- Firebase App ì´ˆê¸° ì„¤ì • -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import {
    getFirestore,
    doc,
    setDoc,
    getDoc,
    getDocs,
    collection
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBYrsPIpbP7wBMJk8QrU9vUtF0JDhfn2C4",
    authDomain: "rd-cre-cbt-sync.firebaseapp.com",
    projectId: "rd-cre-cbt-sync",
    storageBucket: "rd-cre-cbt-sync.firebasestorage.app",
    messagingSenderId: "1085101263930",
    appId: "1:1085101263930:web:06d1339169b431b63e3903"
  };

  const app = initializeApp(firebaseConfig);
  window.db = getFirestore(app);

  function getUID() {
    let uid = localStorage.getItem("cre_uid");
    if (!uid) {
      uid = crypto.randomUUID();
      localStorage.setItem("cre_uid", uid);
    }
    return uid;
  }
  window.USER_UID = getUID();
</script>

<style>
body {
  font-family: Arial, system-ui, sans-serif;
  margin: 0;
  padding: 0;
  background: #f2f4f7;
}

.container {
  max-width: 1100px;
  margin: 20px auto;
  background: #fff;
  border-radius: 10px;
  padding: 20px 24px 40px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  display: none;
}

.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-bottom: 16px;
  padding: 12px;
  background: #f7f9fc;
  border-radius: 8px;
}

label {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 4px;
  display: block;
}

select, input[type="number"], input[type="text"], textarea {
  width: 100%;
  padding: 6px 8px;
  font-size: 14px;
  box-sizing: border-box;
}

button {
  padding: 8px 14px;
  font-size: 14px;
  border-radius: 6px;
  border: 1px solid #1f6feb;
  background: #1f6feb;
  color: #fff;
  cursor: pointer;
}

button.secondary {
  background: #fff;
  color: #1f2933;
  border-color: #cbd2e1;
}

button.danger {
  background: #e11d48;
  border-color: #e11d48;
}

#gateOverlay {
  position: fixed;
  inset: 0;
  background: rgba(15,23,42,0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

#gateBox {
  background: #f9fafb;
  border-radius: 12px;
  padding: 24px;
  width: 320px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.4);
}
</style>

</head>
<body>

<!-- ì¶œì… ê²Œì´íŠ¸ -->
<div id="gateOverlay">
  <div id="gateBox">
    <h2>CRE ì—°ìŠµ ì‚¬ì´íŠ¸</h2>
    <p style="font-size:13px;color:#4b5563;">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
    <input type="password" id="gatePassword" placeholder="ë¹„ë°€ë²ˆí˜¸" />
    <div id="gateMessage"></div>
    <button id="gateBtn">ì…ì¥</button>
  </div>
</div>

<!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
<div class="container" id="appContainer">
  <h1>CRE Practice CBT (Cloud Sync)</h1>

  <!-- ìƒë‹¨ ì˜µì…˜ -->
  <div class="controls">
    <div>
      <label>ì±•í„° ì„ íƒ</label>
      <select id="chapterSelect"></select>
    </div>

    <div>
      <label>ìœ í˜• ì„ íƒ</label>
      <select id="typeSelect">
        <option value="all">A+C ì „ì²´</option>
        <option value="A">A-type</option>
        <option value="C">C-type</option>
      </select>
    </div>

    <div>
      <label>ë¬¸ì œ ìˆ˜</label>
      <input id="countInput" type="number" min="1" max="200" value="10" />
    </div>

    <div>
      <label>íƒ€ì´ë¨¸(ë¶„)</label>
      <input id="timerInput" type="number" min="0" max="240" value="60" />
    </div>

    <div>
      <label>ì¶œì œ ëª¨ë“œ</label>
      <select id="modeSelect">
        <option value="normal">ì¼ë°˜</option>
        <option value="wrong">ì˜¤ë‹µë§Œ</option>
        <option value="weak">ì•½ì  ì±•í„°</option>
      </select>
    </div>

    <div>
      <label>ë³´ê¸° ëª¨ë“œ</label>
      <input type="checkbox" id="dualViewToggle"/> ì˜/í•œ 2ë‹¨
    </div>

    <div style="display:flex;align-items:flex-end;gap:8px;">
      <button id="startBtn">ì‹œí—˜ ì‹œì‘</button>
      <button id="submitBtn" class="secondary" disabled>ì œì¶œ</button>
      <button id="resetBtn" class="secondary" disabled>ì´ˆê¸°í™”</button>
    </div>

    <div style="margin-left:auto; text-align:right;">
      <div id="timer">Timer: OFF</div>
      <div id="modeDesc"></div>
    </div>
  </div>

  <!-- ë¬¸ì œ í‘œì‹œ ì˜ì—­ -->
  <div id="quizBox"></div>

  <!-- ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
  <div id="resultBox"></div>

  <!-- íŒ¨ë„ ì˜ì—­ -->
  <div class="panel-row">
    <!-- ì˜¤ë‹µë…¸íŠ¸ -->
    <div class="panel">
      <h3>ğŸ“’ ì˜¤ë‹µë…¸íŠ¸ (Cloud Sync)</h3>
      <div id="wrongNotesBox"></div>
      <button class="secondary" onclick="clearWrongNotes()">ì˜¤ë‹µë…¸íŠ¸ ì´ˆê¸°í™”</button>
    </div>

    <!-- ì ìˆ˜ ê¸°ë¡ -->
    <div class="panel">
      <h3>ğŸ“Š ì ìˆ˜ ê¸°ë¡ (Cloud Sync)</h3>
      <div id="scoreHistoryBox"></div>
      <button class="secondary" onclick="clearScoreHistory()">ì ìˆ˜ ê¸°ë¡ ì´ˆê¸°í™”</button>
    </div>

    <!-- ë¬¸ì œ ì¶”ê°€ -->
    <div class="panel">
      <h3>â• ë¬¸ì œ ì¶”ê°€ (Local Only)</h3>

      <form id="addQuestionForm">
        <label>ë¬¸ì œ ID</label>
        <input type="text" id="addId" required />

        <label>ì±•í„°</label>
        <select id="addChapter"></select>

        <label>ìœ í˜•</label>
        <select id="addType">
          <option value="A">A-type</option>
          <option value="C">C-type</option>
        </select>

        <label>ë¬¸ì œ ë‚´ìš© (ì˜ë¬¸)</label>
        <textarea id="addText" required></textarea>

        <label>ë³´ê¸° A/B/C/D</label>
        <input type="text" id="addOpA" required />
        <input type="text" id="addOpB" required />
        <input type="text" id="addOpC" required />
        <input type="text" id="addOpD" required />

        <label>ì •ë‹µ (0~3)</label>
        <input type="number" id="addAnswer" min="0" max="3" class="small-input" required />

        <label>í•´ì„¤ (ì„ íƒ)</label>
        <textarea id="addExplanation"></textarea>

        <button type="submit" class="secondary" style="margin-top:8px;">ë¬¸ì œ ì¶”ê°€</button>
      </form>

      <hr style="margin:10px 0;">
      <h4>ğŸ“ JSON ë¬¸ì œ íŒŒì¼ ì—…ë¡œë“œ</h4>
      <input type="file" id="uploadFileInput" accept=".json" />
      <button class="secondary" id="uploadFileBtn" style="margin-top:6px;">íŒŒì¼ì—ì„œ ë¬¸ì œ ì¶”ê°€</button>

      <p style="font-size:11px;color:#6b7280;">
        JSON ë°°ì—´ í˜•ì‹: { id, chapter, type, text, options[4], answer, explanation? }
      </p>

      <hr style="margin:10px 0;">
      <h4>ğŸ“¦ ì‚¬ìš©ì ë¬¸ì œ ê´€ë¦¬</h4>
      <button class="danger" id="clearCustomBtn">ì‚¬ìš©ì ë¬¸ì œ ì‚­ì œ</button>
      <button class="secondary" id="exportCustomBtn" style="margin-top:4px;">ë¬¸ì œ JSON ë‹¤ìš´ë¡œë“œ</button>
    </div>
  </div>


<script>
/******************************************************************
 * BLOCK 3-1 â€” Firestore + LocalStorage í•˜ì´ë¸Œë¦¬ë“œ ì—”ì§„
 ******************************************************************/

/*********** CUSTOM QUESTIONS (Local Only) ***********/
const loadCustomQuestions = () =>
  JSON.parse(localStorage.getItem("creCustomQuestions") || "[]");

const saveCustomQuestions = (v) =>
  localStorage.setItem("creCustomQuestions", JSON.stringify(v));

/*********** WRONG NOTES â€” Firestore + LocalStorage ***********/
async function fsSaveWrongNote(note) {
  const ref = doc(db, "users", USER_UID, "wrong_notes", note.id);
  await setDoc(ref, note, { merge: true });
}

async function fsLoadWrongNotes() {
  const snap = await getDocs(collection(db, "users", USER_UID, "wrong_notes"));
  return snap.docs.map((d) => d.data());
}

async function loadWrongNotes() {
  const local = JSON.parse(localStorage.getItem("creWrongNotes") || "[]");
  try {
    const remote = await fsLoadWrongNotes();
    localStorage.setItem("creWrongNotes", JSON.stringify(remote));
    return remote;
  } catch (err) {
    return local;
  }
}

async function saveWrongNotes(list) {
  localStorage.setItem("creWrongNotes", JSON.stringify(list));
  for (const item of list) await fsSaveWrongNote(item);
}

/*********** SCORE â€” Firestore + LocalStorage ***********/
async function fsSaveScore(scoreObj) {
  const id = String(scoreObj.timestamp);
  await setDoc(doc(db, "users", USER_UID, "scores", id), scoreObj);
}

async function fsLoadScores() {
  const snap = await getDocs(collection(db, "users", USER_UID, "scores"));
  return snap.docs.map((d) => d.data());
}

async function loadScoreHistory() {
  const local = JSON.parse(localStorage.getItem("creScoreHistory") || "[]");
  try {
    const remote = await fsLoadScores();
    localStorage.setItem("creScoreHistory", JSON.stringify(remote));
    return remote;
  } catch {
    return local;
  }
}

async function saveScoreHistory(list) {
  localStorage.setItem("creScoreHistory", JSON.stringify(list));
  for (const s of list) await fsSaveScore(s);
}

/******************************************************************
 * BASE QUESTIONS â€” ê³ ì • ë¬¸ì œ (ì¼ë¶€ë§Œ)
 ******************************************************************/
const BASE_QUESTIONS = [
  {
    id: "Q1",
    chapter: "ìƒ˜í”Œ - Statistical Concepts",
    type: "C",
    text:
      "For an exponential distribution with MTBF = 800 hours, what is the reliability at 400 hours?",
    options: ["0.50", "0.61", "0.37", "0.80"],
    answer: 1,
    explanation:
      "R(t) = exp(-t/MTBF) = exp(-400/800) = exp(-0.5) â‰ˆ 0.606"
  },
  {
    id: "Q2",
    chapter: "ìƒ˜í”Œ - Statistical Concepts",
    type: "A",
    text: "In a Weibull distribution, what does a shape parameter Î² > 1 indicate?",
    options: [
      "Early-life failures",
      "Wear-out failures (increasing failure rate)",
      "Constant failure rate",
      "Random failures"
    ],
    answer: 1,
    explanation: "Î²>1 means wear-out region with increasing hazard rate."
  }
];

const getAllQuestions = () =>
  BASE_QUESTIONS.concat(loadCustomQuestions());
</script>

<script>
/******************************************************************
 * BLOCK 3-2 â€” ì±•í„° ìë™ ìƒì„± + ë Œë”ë§ ê¸°ë³¸ í•¨ìˆ˜ë“¤
 ******************************************************************/

/*** ì±•í„° ë“œë¡­ë‹¤ìš´ ê°±ì‹  ***/
function refreshChapterDropdown() {
  const chSel = document.getElementById("chapterSelect");
  const chAdd = document.getElementById("addChapter");

  const all = getAllQuestions();
  const chapters = new Set(["ì „ì²´"]);

  all.forEach((q) => chapters.add(q.chapter));

  let mainHTML = "";
  let addHTML = "";

  chapters.forEach((ch) => {
    mainHTML += `<option value="${ch === "ì „ì²´" ? "all" : ch}">${ch}</option>`;
    if (ch !== "ì „ì²´") addHTML += `<option value="${ch}">${ch}</option>`;
  });

  chSel.innerHTML = mainHTML;
  chAdd.innerHTML = addHTML;
}

/******************************************************************
 * ì˜¤ë‹µë…¸íŠ¸ ë Œë”ë§
 ******************************************************************/
async function renderWrongNotes() {
  const notes = await loadWrongNotes();
  const box = document.getElementById("wrongNotesBox");

  if (!notes.length) {
    box.innerHTML = `<div style="font-size:12px;color:#888;">ì˜¤ë‹µ ì—†ìŒ</div>`;
    return;
  }

  box.innerHTML = notes
    .map(
      (n) => `
      <div class="note-item">
        <b>${n.id}</b>
        <span class="tag ${n.type}">${n.type}</span>
        <div>${n.text}</div>
        <div style="font-size:11px;color:#666;">
          ${n.chapter} Â· ${n.missCount}íšŒ Â· ${n.lastDate}
        </div>
      </div>
      `
    )
    .join("");
}

/******************************************************************
 * ì ìˆ˜ ê¸°ë¡ ë Œë”ë§
 ******************************************************************/
async function renderScoreHistory() {
  const hist = await loadScoreHistory();
  const box = document.getElementById("scoreHistoryBox");

  if (!hist.length) {
    box.innerHTML = `<div style="font-size:12px;color:#888;">ê¸°ë¡ ì—†ìŒ</div>`;
    return;
  }

  box.innerHTML = hist
    .slice()
    .reverse()
    .map(
      (h) => `
      <div class="score-item">
        <b>${h.date}</b> â€” ${h.correct}/${h.total}
        (${Math.round((h.correct / h.total) * 100)}%)
        <div style="font-size:11px;color:#555;">
          ${h.mode} Â· ${h.durationSec}s
        </div>
      </div>
      `
    )
    .join("");
}

/******************************************************************
 * ì˜¤ë‹µ/ì ìˆ˜ ì´ˆê¸°í™” ë²„íŠ¼
 ******************************************************************/
async function clearWrongNotes() {
  if (!confirm("ì˜¤ë‹µë…¸íŠ¸ë¥¼ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?")) return;
  await saveWrongNotes([]);
  renderWrongNotes();
}

async function clearScoreHistory() {
  if (!confirm("ì ìˆ˜ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?")) return;
  await saveScoreHistory([]);
  renderScoreHistory();
}

</script>

<script>
/******************************************************************
 * BLOCK 3-3 â€” ë²ˆì—­ ì—”ì§„ + 2ë‹¨ ë³´ê¸° ë Œë”ë§
 ******************************************************************/

/*** ê¸°ìˆ  ë²ˆì—­ ì‚¬ì „ ê¸°ë°˜ ë³€í™˜ ***/
function translateTechTerm(text) {
  if (!text) return "";
  let out = text;

  const dict = {
    "reliability": "ì‹ ë¢°ë„",
    "availability": "ê°€ìš©ë„",
    "maintainability": "ì •ë¹„ì„±",
    "MTBF": "í‰ê· ê³ ì¥ê°„ê²©(MTBF)",
    "MTTR": "í‰ê· ìˆ˜ë¦¬ì‹œê°„(MTTR)",
    "failure rate": "ê³ ì¥ë¥ ",
    "hazard rate": "ìœ„í—˜ë¥ ",
    "exponential distribution": "ì§€ìˆ˜ë¶„í¬",
    "weibull distribution": "ì™€ì´ë¸” ë¶„í¬",
    "weibull": "ì™€ì´ë¸”"
  };

  for (const [en, ko] of Object.entries(dict)) {
    const re = new RegExp(en, "gi");
    out = out.replace(re, ko + " (" + en + ")");
  }
  return out;
}

/*** ìì—° ë²ˆì—­ íŒ¨í„´ ***/
function translateNaturalSentence(text) {
  if (!text) return "";
  let out = text;

  out = out.replace(/Which of the following/gi, "ë‹¤ìŒ ì¤‘");
  out = out.replace(/Which is NOT/gi, "ë‹¤ìŒ ì¤‘ ì˜³ì§€ ì•Šì€ ê²ƒì€");
  out = out.replace(/\?/g, "ì¸ê°€?");

  return out;
}

/*** í•œêµ­ì–´ ë²ˆì—­ ë¸”ë¡ ë§Œë“¤ê¸° ***/
function buildKoreanQuestionBlock(q) {
  const techQ = translateTechTerm(q.text);
  const natQ = translateNaturalSentence(q.text);

  let html = `
    <div class="ko-header">Q${q._no} í•œê¸€ ë²ˆì—­</div>
    <div class="ko-label">ê¸°ìˆ  ë²ˆì—­</div>
    <div>${techQ}</div>
    <div class="ko-label">ìì—° ë²ˆì—­</div>
    <div>${natQ}</div>
    <div class="ko-label" style="margin-top:6px;">ë³´ê¸° ë²ˆì—­</div>
  `;

  q.options.forEach((op, idx) => {
    const techOp = translateTechTerm(op);
    const natOp = translateNaturalSentence(op);
    const ch = String.fromCharCode(65 + idx);

    html += `
      <div class="ko-option">
        <b>${ch}.</b> ${techOp}
        <div style="margin-left:18px;">${natOp}</div>
      </div>
    `;
  });

  return html;
}

</script>

<script>
/******************************************************************
 * BLOCK 3-4 â€” ë¬¸ì œ ë Œë”ë§ + ì¶œì œ ì—”ì§„ + íƒ€ì´ë¨¸
 ******************************************************************/

/*** íƒ€ì´ë¨¸ ê´€ë ¨ ë³€ìˆ˜ ***/
let timerId = null;
let timerSeconds = 0;
let quizStarted = false;
let quizStartTime = null;
let currentQuiz = [];
let dualViewEnabled = false;

/******************************************************************
 * íƒ€ì´ë¨¸ ì œì–´
 ******************************************************************/
function stopTimer() {
  if (timerId !== null) {
    clearInterval(timerId);
    timerId = null;
  }
}

function updateTimerDisplay() {
  const el = document.getElementById("timer");
  if (timerSeconds <= 0) {
    el.textContent = "Timer: OFF";
    return;
  }
  const m = String(Math.floor(timerSeconds / 60)).padStart(2, "0");
  const s = String(timerSeconds % 60).padStart(2, "0");
  el.textContent = `ë‚¨ì€ ì‹œê°„: ${m}:${s}`;
}

function startTimer(sec) {
  stopTimer();
  timerSeconds = sec;
  updateTimerDisplay();

  if (sec <= 0) return;

  timerId = setInterval(() => {
    timerSeconds--;
    updateTimerDisplay();
    if (timerSeconds <= 0) {
      stopTimer();
      alert("ì‹œê°„ ì¢…ë£Œ! ìë™ ì œì¶œë©ë‹ˆë‹¤.");
      submitQuiz(true);
    }
  }, 1000);
}

/******************************************************************
 * ë°°ì—´ ì…”í”Œ
 ******************************************************************/
const shuffleArray = (arr) => {
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
};

/******************************************************************
 * ë¬¸ì œ ë Œë”ë§
 ******************************************************************/
function renderQuiz() {
  const box = document.getElementById("quizBox");
  box.innerHTML = "";

  const dual = dualViewEnabled;

  currentQuiz.forEach((q, idx) => {
    q._no = idx + 1;

    if (!dual) {
      /* ì˜ì–´ë§Œ í‘œì‹œ */
      let h = `
        <div class="question-block">
          <div class="question-title">Q${idx + 1}. ${q.text}</div>
          <div class="meta">${q.id} Â· ${q.chapter} Â· ${q.type}</div>
      `;
      q.options.forEach((op, j) => {
        h += `
          <div class="option">
            <label>
              <input type="radio" name="q${idx}" value="${j}">
              ${String.fromCharCode(65 + j)}. ${op}
            </label>
          </div>`;
      });
      h += "</div>";
      box.innerHTML += h;

    } else {
      /* 2ë‹¨(ì˜/í•œ) ë³´ê¸° */
      let left = `
        <div class="q-left">
          <div class="question-title">Q${idx + 1}. ${q.text}</div>
          <div class="meta">${q.id} Â· ${q.chapter} Â· ${q.type}</div>
      `;
      q.options.forEach((op, j) => {
        left += `
          <div class="option">
            <label>
              <input type="radio" name="q${idx}" value="${j}">
              ${String.fromCharCode(65 + j)}. ${op}
            </label>
          </div>`;
      });
      left += "</div>";

      const right = `<div class="q-right">${buildKoreanQuestionBlock(q)}</div>`;

      box.innerHTML += `<div class="question-block dual">${left}${right}</div>`;
    }
  });
}

/******************************************************************
 * ì¶œì œ ì—”ì§„ â€” ëª¨ë“œì— ë”°ë¼ ë¬¸ì œ pool êµ¬ì„±
 ******************************************************************/
function buildQuestionPool(all, notes) {
  const ch = document.getElementById("chapterSelect").value;
  const tp = document.getElementById("typeSelect").value;
  const mode = document.getElementById("modeSelect").value;

  if (mode === "normal") {
    return {
      pool: all.filter(
        (q) =>
          (ch === "all" || q.chapter === ch) &&
          (tp === "all" || q.type === tp)
      ),
      autoChapter: null,
    };
  }

  if (mode === "wrong") {
    const wrongIds = new Set(notes.map((n) => n.id));
    return {
      pool: all.filter(
        (q) =>
          wrongIds.has(q.id) &&
          (ch === "all" || q.chapter === ch) &&
          (tp === "all" || q.type === tp)
      ),
      autoChapter: null,
    };
  }

  if (mode === "weak") {
    if (!notes.length) return { pool: [], autoChapter: null };

    const count = {};
    notes.forEach((n) => {
      count[n.chapter] = (count[n.chapter] || 0) + n.missCount;
    });

    let weak = null,
      max = -1;
    for (const c in count) {
      if (count[c] > max) {
        max = count[c];
        weak = c;
      }
    }

    const tp = document.getElementById("typeSelect").value;

    return {
      pool: all.filter(
        (q) => q.chapter === weak && (tp === "all" || q.type === tp)
      ),
      autoChapter: weak,
    };
  }
}

/******************************************************************
 * ì‹œí—˜ ì‹œì‘
 ******************************************************************/
async function startQuiz() {
  const cnt = Number(document.getElementById("countInput").value);
  const tm = Number(document.getElementById("timerInput").value);

  const all = getAllQuestions();
  const notes = await loadWrongNotes();

  const { pool, autoChapter } = buildQuestionPool(all, notes);
  if (!pool.length) {
    alert("ì¶œì œ ê°€ëŠ¥í•œ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤!");
    return;
  }

  currentQuiz = shuffleArray(pool).slice(0, cnt || pool.length);
  renderQuiz();

  quizStarted = true;
  quizStartTime = Date.now();

  document.getElementById("resultBox").innerHTML = "";
  document.getElementById("startBtn").disabled = true;
  document.getElementById("submitBtn").disabled = false;
  document.getElementById("resetBtn").disabled = false;

  const modeTxt = [];
  const mode = document.getElementById("modeSelect").value;

  modeTxt.push(mode === "normal" ? "ì¼ë°˜" : mode === "wrong" ? "ì˜¤ë‹µë§Œ" : "ì•½ì ");

  if (mode === "weak" && autoChapter) {
    modeTxt.push("ì±•í„°=" + autoChapter);
  } else {
    const ch = document.getElementById("chapterSelect").value;
    modeTxt.push(ch === "all" ? "ì „ì²´" : "ì±•í„°=" + ch);
  }

  const tp = document.getElementById("typeSelect").value;
  modeTxt.push(tp === "all" ? "A+C" : "ìœ í˜•=" + tp);
  modeTxt.push("ë¬¸ì œ=" + currentQuiz.length);

  document.getElementById("modeDesc").textContent = modeTxt.join(" / ");

  startTimer(tm > 0 ? tm * 60 : 0);
}

</script>

<script>
/******************************************************************
 * BLOCK 3-5 â€” ì œì¶œ & ì±„ì  + Firestore ì €ì¥ + ìë™ ë³µìŠµë¬¸ì œ ìƒì„±
 ******************************************************************/

/******************************************************************
 * ìë™ ë³µìŠµë¬¸ì œ ìƒì„± ì—”ì§„
 ******************************************************************/
function autoGenerateQuestionsFromWrong(wrongList, notes) {
  if (!wrongList || !wrongList.length) return;

  const custom = loadCustomQuestions();
  const allIds = new Set([
    ...BASE_QUESTIONS.map((q) => q.id),
    ...custom.map((q) => q.id),
  ]);

  let added = 0;

  wrongList.forEach((q) => {
    const note = notes.find((n) => n.id === q.id);
    if (!note) return;

    if (note.missCount < 2) return;

    const base = q.id + "-R";
    if (custom.some((c) => c.id.startsWith(base))) return;

    const shuffledOptions = shuffleArray(q.options);
    const correctValue = q.options[q.answer];
    const newAnswerIdx = shuffledOptions.indexOf(correctValue);
    if (newAnswerIdx < 0) return;

    let newId = base;
    let n = 1;
    while (allIds.has(newId)) {
      newId = base + "-" + n;
      n++;
    }
    allIds.add(newId);

    const newQ = {
      id: newId,
      chapter: q.chapter,
      type: q.type,
      text: "[Review] " + q.text,
      options: shuffledOptions,
      answer: newAnswerIdx,
      explanation:
        "(Auto-generated review question from " + q.id + ") " +
        (q.explanation || ""),
    };

    custom.push(newQ);
    added++;
  });

  if (added > 0) {
    saveCustomQuestions(custom);
    refreshChapterDropdown();
  }
}

/******************************************************************
 * ì œì¶œ / ì±„ì 
 ******************************************************************/
async function submitQuiz(auto = false) {
  if (!quizStarted) return;
  quizStarted = false;
  stopTimer();

  const duration = Math.round((Date.now() - quizStartTime) / 1000);
  let correct = 0;
  const wrong = [];

  let html = "";

  currentQuiz.forEach((q, idx) => {
    const sel = document.querySelector(`input[name="q${idx}"]:checked`);
    const userValue = sel ? Number(sel.value) : null;

    const ok = userValue === q.answer;
    if (ok) correct++;
    else wrong.push(q);

    const techQ = translateTechTerm(q.text);
    const natQ = translateNaturalSentence(q.text);

    html += `
      <div style="margin-bottom:12px;">
        <b>Q${idx + 1} (${q.id})</b><br>
        ì„ íƒ: ${
          userValue === null
            ? "ë¬´ì‘ë‹µ"
            : String.fromCharCode(65 + userValue) + ". " + q.options[userValue]
        }<br>
        ì •ë‹µ:
        <span style="color:${ok ? "#16a34a" : "#dc2626"}">
          ${String.fromCharCode(65 + q.answer)}. ${q.options[q.answer]}
        </span>
        <div class="explanation">${q.explanation || ""}</div>
        <div class="ko-result-block">
          <b>[ë¬¸ì œ ê¸°ìˆ  ë²ˆì—­]</b> ${techQ}<br/>
          <b>[ë¬¸ì œ ìì—° ë²ˆì—­]</b> ${natQ}
        </div>
      </div>
    `;
  });

  const pct = Math.round((correct / currentQuiz.length) * 100);

  document.getElementById("resultBox").innerHTML = `
    <h3>ì ìˆ˜: ${correct}/${currentQuiz.length} (${pct}%)</h3>
    <div style="font-size:12px;color:#666;">
      ì†Œìš”ì‹œê°„: ${duration}s ${auto ? "(ìë™ ì œì¶œ)" : ""}
    </div>
    ${html}
  `;
  document.getElementById("submitBtn").disabled = true;

  /******************************************************************
   * ì˜¤ë‹µ ì €ì¥ (Local + Firestore)
   ******************************************************************/
  let notes = await loadWrongNotes();
  if (wrong.length) {
    const now = new Date().toLocaleString();

    wrong.forEach((q) => {
      const ex = notes.find((n) => n.id === q.id);
      if (ex) {
        ex.missCount++;
        ex.lastDate = now;
      } else {
        notes.push({
          id: q.id,
          text: q.text,
          chapter: q.chapter,
          type: q.type,
          missCount: 1,
          lastDate: now,
        });
      }
    });

    await saveWrongNotes(notes);
    renderWrongNotes();

    autoGenerateQuestionsFromWrong(wrong, notes);
  }

  /******************************************************************
   * ì ìˆ˜ ì €ì¥ (Local + Firestore)
   ******************************************************************/
  const hist = await loadScoreHistory();
  const scoreObj = {
    timestamp: Date.now(),
    date: new Date().toLocaleString(),
    mode: document.getElementById("modeDesc").textContent,
    total: currentQuiz.length,
    correct,
    durationSec: duration,
  };

  hist.push(scoreObj);
  await saveScoreHistory(hist);
  renderScoreHistory();
}

</script>

<script>
/******************************************************************
 * BLOCK 3-6 â€” ë¬¸ì œ ì¶”ê°€ + JSON ì—…ë¡œë“œ + Gate + DualView + ì´ˆê¸°í™”
 ******************************************************************/

/******************************************************************
 * ìœ ë‹ˆí¬ ID ê°•ì œ ë¶€ì—¬
 ******************************************************************/
function ensureUniqueId(originalId, existingSet) {
  if (!existingSet.has(originalId)) return originalId;
  let base = originalId;
  let n = 1;
  while (existingSet.has(base + "-" + n)) n++;
  return base + "-" + n;
}

/******************************************************************
 * ë¬¸ì œ ì¶”ê°€ í¼
 ******************************************************************/
function setupAddQuestionForm() {
  const form = document.getElementById("addQuestionForm");

  form.addEventListener("submit", (e) => {
    e.preventDefault();

    const custom = loadCustomQuestions();
    const existingIds = new Set([
      ...BASE_QUESTIONS.map((q) => q.id),
      ...custom.map((q) => q.id),
    ]);

    const rawId = document.getElementById("addId").value.trim();
    const id = ensureUniqueId(rawId, existingIds);
    existingIds.add(id);

    const q = {
      id,
      chapter: document.getElementById("addChapter").value,
      type: document.getElementById("addType").value,
      text: document.getElementById("addText").value.trim(),
      options: [
        document.getElementById("addOpA").value.trim(),
        document.getElementById("addOpB").value.trim(),
        document.getElementById("addOpC").value.trim(),
        document.getElementById("addOpD").value.trim(),
      ],
      answer: Number(document.getElementById("addAnswer").value),
      explanation: document.getElementById("addExplanation").value.trim() || "",
    };

    custom.push(q);
    saveCustomQuestions(custom);
    refreshChapterDropdown();

    alert("ë¬¸ì œ ì¶”ê°€ ì™„ë£Œ! (ID: " + id + ")");
    form.reset();
  });
}

/******************************************************************
 * JSON ë¬¸ì œ íŒŒì¼ ì—…ë¡œë“œ
 ******************************************************************/
function setupUploadQuestions() {
  const input = document.getElementById("uploadFileInput");
  const btn = document.getElementById("uploadFileBtn");

  btn.addEventListener("click", () => {
    const file = input.files?.[0];
    if (!file) {
      alert("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
      return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const arr = JSON.parse(e.target.result);
        if (!Array.isArray(arr)) {
          alert("JSON ë°°ì—´ í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
          return;
        }

        const custom = loadCustomQuestions();
        const existingIds = new Set([
          ...BASE_QUESTIONS.map((q) => q.id),
          ...custom.map((q) => q.id),
        ]);

        const added = [];

        arr.forEach((q) => {
          if (
            !q.id ||
            !q.chapter ||
            !q.text ||
            !Array.isArray(q.options) ||
            q.options.length !== 4 ||
            typeof q.answer !== "number"
          )
            return;

          const newId = ensureUniqueId(q.id, existingIds);
          existingIds.add(newId);
          q.id = newId;

          if (!("explanation" in q)) q.explanation = "";
          added.push(q);
        });

        if (!added.length) {
          alert("ì¶”ê°€í•  ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        saveCustomQuestions(custom.concat(added));
        refreshChapterDropdown();
        alert(added.length + "ë¬¸ì œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");
      } catch (err) {
        alert("JSON íŒŒì‹± ì˜¤ë¥˜");
      }
    };

    reader.readAsText(file);
  });
}

/******************************************************************
 * ì‚¬ìš©ì ë¬¸ì œ ê´€ë¦¬
 ******************************************************************/
function setupCustomManagement() {
  document.getElementById("clearCustomBtn").addEventListener("click", () => {
    if (!confirm("ì‚¬ìš©ì ë¬¸ì œ ì „ì²´ ì‚­ì œ?")) return;
    saveCustomQuestions([]);
    refreshChapterDropdown();
  });

  document
    .getElementById("exportCustomBtn")
    .addEventListener("click", () => {
      const data = loadCustomQuestions();
      if (!data.length) {
        alert("ì €ì¥ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const blob = new Blob([JSON.stringify(data, null, 2)], {
        type: "application/json",
      });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "cre_custom_questions.json";
      a.click();

      URL.revokeObjectURL(url);
    });
}

/******************************************************************
 * DualView í† ê¸€
 ******************************************************************/
function setupDualViewToggle() {
  const cb = document.getElementById("dualViewToggle");
  cb.addEventListener("change", () => {
    dualViewEnabled = cb.checked;
    localStorage.setItem("creDualView", cb.checked ? "1" : "0");
    if (currentQuiz.length) renderQuiz();
  });

  const saved = localStorage.getItem("creDualView") === "1";
  cb.checked = saved;
  dualViewEnabled = saved;
}

/******************************************************************
 * Reset ë²„íŠ¼
 ******************************************************************/
function resetQuiz() {
  stopTimer();
  quizStarted = false;
  currentQuiz = [];
  document.getElementById("quizBox").innerHTML = "";
  document.getElementById("resultBox").innerHTML = "";
  document.getElementById("modeDesc").textContent = "";
  document.getElementById("timer").textContent = "Timer: OFF";

  document.getElementById("startBtn").disabled = false;
  document.getElementById("submitBtn").disabled = true;
  document.getElementById("resetBtn").disabled = true;
}

/******************************************************************
 * ë¹„ë°€ë²ˆí˜¸ ê²Œì´íŠ¸
 ******************************************************************/
function setupGate() {
  const ov = document.getElementById("gateOverlay");
  const input = document.getElementById("gatePassword");
  const btn = document.getElementById("gateBtn");
  const app = document.getElementById("appContainer");
  const msg = document.getElementById("gateMessage");

  function enter() {
    if (input.value === APP_PASSWORD) {
      ov.style.display = "none";
      app.style.display = "block";

      renderWrongNotes();
      renderScoreHistory();
      refreshChapterDropdown();
    } else {
      msg.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
    }
  }

  btn.addEventListener("click", enter);
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") enter();
  });
}

/******************************************************************
 * ì´ˆê¸° ì‹¤í–‰
 ******************************************************************/
document.getElementById("startBtn").addEventListener("click", startQuiz);
document.getElementById("submitBtn").addEventListener("click", () =>
  submitQuiz(false)
);
document.getElementById("resetBtn").addEventListener("click", resetQuiz);

setupAddQuestionForm();
setupUploadQuestions();
setupCustomManagement();
setupDualViewToggle();
setupGate();
</script>

</body>
</html>
